function zoomin_book(a,b,c,d){c.initPage=d,a.zoomin_book=!0;var e=event.currentTarget.offsetParent.offsetLeft+event.currentTarget.offsetWidth,f=event.screenX,g=event.currentTarget.offsetParent.offsetParent.scrollWidth;a.$emit("expandBook",a.book.id,e,f,g);var h=b(function(){a.zoomin_book=!1},3e3);a.$on("destroy",function(){b.cancel(h)})}function add_custom_bookmark(a,b,c){var d=a.book.custom_bookmark;if(d){d=d.trim().toUpperCase();for(var e=a.book.labels,f=!1,g=0;g<e.length;g++){var h=e[g];if(h.name==d){f=!0;var i="ALERT- Bookmark with the name '"+d+"' is already added in the list";break}}if(!f){a.book.bookmark_status=1,b.labels=b.labels.concat([{name:d}]),a.book.labels=a.book.labels.concat([{name:d,checked:!0}]);var i="SUCCESS-Custom Bookmark "+d+" added to book "+a.book.title}var j=notify(b,i,c);return a.$on("destroy",function(){c.cancel(j)}),f}}websiteApp.directive("book",["websiteService","$rootScope","widgetService",function(a,b,c){return{restrict:"E",scope:{book:"=data"},controller:["$scope",function(d){d.show_focused_tooltip=function(a){if(b.focused_book!=d.book){b.ticker_popup=null,b.focused_book=d.book;var e=a.currentTarget.offsetParent.offsetParent.offsetLeft-a.pageX+a.clientX,f=screen.width-(e+a.currentTarget.offsetParent.scrollWidth),g=e;f>g?(f>400?(e=e+a.currentTarget.offsetParent.scrollWidth-a.currentTarget.offsetLeft,b.focused_book.reposition_tooltip={left:e+"px"}):b.focused_book.reposition_tooltip={right:"0px"},b.on_left=!0):(g>400?(e=screen.width-e,b.focused_book.reposition_tooltip={right:e+"px"}):b.focused_book.reposition_tooltip={left:"0px"},b.on_left=!1),c.get_book_feed(b.focused_book.id).then(function(){})}else b.focused_book=null;a.stopPropagation()},(_init=function(){var c=d.book.id;d.book.tweets=[],d.book.show_labels=!1,angular.isArray(d.book.labels)||(d.book.labels=[],angular.forEach(b.labels,function(a){this.push({name:a.name})},d.book.labels)),a.get_book_details("id="+c).then(function(a){angular.extend(d.book,a)})})()}],templateUrl:"/assets/angular/widgets/base/book/book_widget.html"}}]),websiteApp.directive("labelDropdown",["$rootScope","$timeout","widgetService",function(a,b,c){return{restrict:"E",controller:["$scope",function(d){d.stop_propagation=function(a){a.stopPropagation()},d.select_label=function(e){var f=!1,g=d.book.labels;if(d.book.labels[e].checked=!d.book.labels[e].checked,d.book.labels[e].checked)var h="Bookmark tagged.";else var h="Bookmark removed.";var i=notify(a,h,b),j={id:d.book.id,type:"BOOK",name:d.book.labels[e].name,data:d.book.labels[e].checked};c.bookmark(j),d.$on("destroy",function(){b.cancel(i)});for(var k=0;k<g.length;k++)if(g[k].checked){f=!0;break}d.book.bookmark_status=f?1:0},d.stop_horizontal_scroll=function(a){a.stopPropagation()}}],templateUrl:"/assets/angular/widgets/base/book/label_dropdown.html"}}]),websiteApp.directive("bookNavbar",["$rootScope","$timeout",function(a,b){return{restrict:"E",controller:["$scope",function(c){c.show_book=function(d){zoomin_book(c,b,a,d)}}],templateUrl:"/assets/angular/widgets/base/book/book_navbar.html"}}]),websiteApp.directive("listDropdown",function(){return{restrict:"E",controller:function(){},templateUrl:"app/assets/javascripts/angular/widgets/base/book/list_dropdown.html"}}),websiteApp.directive("bookBookmark",["$rootScope","$timeout","widgetService",function(a,b,c){return{restrict:"E",controller:["$scope",function(d){d.toggle_bookmarked=function(e){for(var f=d.book.labels.length,g=a.labels.length,h=f;g>h;h++)d.book.labels.push({name:a.labels[h].name});if(d.book.show_labels){{d.book.bookmark_status,d.book.title,d.book.author_name}if(d.book.custom_bookmark){var i=add_custom_bookmark(d,a,b);if(!i){var j={id:d.book.id,type:"BOOK",name:d.book.custom_bookmark,data:!0};c.bookmark(j)}}else d.book.show_labels=!1}else d.book.show_labels=!0;e.stopPropagation()}}],templateUrl:"/assets/angular/widgets/base/book/bookmark.html"}}]),websiteApp.directive("bookInteract",["$rootScope","$timeout","widgetService",function(a,b,c){return{restrict:"E",controller:["$scope",function(d){_init=function(){d.setStatus()},d.show_bookmark_options=function(b){if(d.book.show_labels)d.book.blur_input=!0,d.book.show_labels=!1;else{for(var c=d.book.labels.length,e=a.labels.length,f=c;e>f;f++)d.book.labels.push({name:a.labels[f].name});d.book.blur_input=!1,d.book.show_labels=!0}b.stopPropagation()},d.handle_enter=function(e){var f=13==e.keyCode;if(f){var g=add_custom_bookmark(d,a,b);if(!g){var h={id:d.book.id,type:"BOOK",name:d.book.custom_bookmark,data:!0};c.bookmark(h),d.book.custom_bookmark=""}}},d.setStatus=function(a){d.read=1==a?!0:!1},_init()}],templateUrl:"/assets/angular/widgets/base/book/interact_widget.html"}}]),websiteApp.directive("rate",["$rootScope","$timeout","widgetService","sharedService",function(a,b,c,d){return{restrict:"E",scope:{rate_object:"=data"},controller:["$scope",function(e){e.show_if_rated=function(a){e.temp_rating=e.rate_object.user_rating,e.rate_object.user_rating=parseInt(a)+1,e.ready_to_rate=!0},e.reset_rating=function(){e.ready_to_rate=!1,e.rate_object.user_rating=e.temp_rating},e.mark_as_rated=function(f,g){e.rate_object.rated=!0,e.rate_object.user_rating=parseInt(f)+1,e.temp_rating=parseInt(f)+1;var h=notify(a,"SUCCESS-Thanks, This will help us to recommend you better books.",b);e.$on("destroy",function(){b.cancel(h)});var i={id:e.rate_object.id,data:e.rate_object.user_rating};(angular.isUndefined(e.rate_object.status)||!e.rate_object.status)&&d.mark_as_read(e,e.rate_object,g),c.rate_this_book(i),g.stopPropagation()},e.is_active=function(a){var b=!1;if(e.rate_object){var c=parseInt(a)+1;c<=e.rate_object.user_rating&&(b=!0)}return b}}],templateUrl:"/assets/angular/widgets/base/book/rate.html"}}]),websiteApp.directive("focusedBook",["$rootScope","$timeout","widgetService","sharedService",function(a,b,c,d){return{restrict:"E",controller:["$scope",function(e){e.handle_enter=function(b,d){var f=13==b.keyCode;if(f){e.add_thumb=!1;var g=a.focused_book.title,h=a.focused_book.author_name,i="/#/user/1/book/"+g+"/author/"+h,j={thumb_url:d,title:g,book_url:i,username:a.user.name,user_thumb:a.user.thumb,user_link:""};c.add_thumbnail(j).then(function(){})}},e.show_feedback_popup=function(){a.focused_book.show_feedback_popup=a.focused_book.show_feedback_popup?!1:!0},e.stop_propagation=function(a){a.stopPropagation()},e.close_focused_tooltip=function(){a.focused_book=null},e.own_this_book=function(){if(e.have_this_book){e.have_this_book=!1;var d="SUCCESS-Are you sure, you don't have a copy of "+a.focused_book.title+"? <br/>Your friends might be looking for this book."}else{e.have_this_book=!0;var d="SUCCESS-Thanks, Your friends will now know that you own a copy of "+a.focused_book.title}var f=a.focused_book.id,g=notify(a,d,b);c.own_this_book(f,e.have_this_book),e.$on("destroy",function(){b.cancel(g)})},e.record_read_time=function(f,g){a.focused_book.time_index=f;{var h="SUCCESS-Thanks we have recorded your approximate time to read "+a.focused_book.title+". <br/> This will help us to recommend you books according to your reading skills.";notify(a,h,b)}a.focused_book.status||d.mark_as_read(a,a.focused_book,g),c.record_time(a.focused_book.id,f),e.$on("destroy",function(){b.cancel("timeout_event")})},e.is_timer=function(b){var c=!1;return a.focused_book.time_index==b&&(c=!0),c},e.close_interaction_box=function(){a.focused_book.interact=!1,e.hash_tags=[]},e.stop_horizontal_scroll=function(a){a.stopPropagation()},_display_tweet=function(c){if(0!=a.focused_book.tweets.length){var d=a.focused_book.tweets,f=b(function(){c<d.length?(a.focused_book.display_tweet=a.focused_book.tweets[c].tweet,a.focused_book.display_profile=a.focused_book.tweets[c].tweet?a.focused_book.tweets[c].thumb:"/assets/profile_pic.jpeg",c++,_display_tweet(c)):_display_tweet(0)},2e3);e.$on("destroy",function(){b.cancel(f)})}else a.focused_book.display_profile=null,a.focused_book.display_tweet="What do you feel about this book?"},_open_tab=function(){e.show_info=!0},(_init=function(){c.get_affiliate_links(a.focused_book.id).then(function(a){e.bnn_links=a.bnn.links}),_display_tweet(0),_open_tab(),e.add_thumb=!1})()}],templateUrl:"/assets/angular/widgets/base/book/focused_book.html"}}]),websiteApp.directive("interactionBox",["$rootScope","$timeout","websiteService","widgetService",function(a,b,c,d){return{restrict:"E",controller:["$scope",function(b){b.update_hashtagged_comment=function(){},b.stop_propagation=function(a){a.stopPropagation()},b.close_interaction_box=function(){a.focused_book.interact=!1,b.hash_tags=[]},b.stop_horizontal_scroll=function(a){a.stopPropagation()},b.handle_selection=function(c){b.current=0;var d=a.focused_book.current_comment.split(" "),e=a.focused_book.hash_tagged_comment.split(" "),f=(String.fromCharCode(event.keyCode),d.length);if(1==f)var g=d.slice(0,f-1).join(" ").trim(),h=e.slice(0,f-1).join(" ").trim();else var g=d.slice(0,f-1).join(" ")+" ",h=e.slice(0,f-1).join(" ")+" ";d.pop(),e.pop(),8==event.keyCode,b.hash_tagging;a.focused_book.hash_tagged_comment=h+"<b>"+c+"</b>",a.focused_book.current_comment=g+c,b.hash_tags=null,event.stopPropagation()},b.handle_backspace=function(c){var d=a.focused_book.current_comment.split(" "),e=a.focused_book.hash_tagged_comment.split(" "),f=(String.fromCharCode(c.keyCode),d.length);if(1==f)var g=d.slice(0,f-1).join(" "),h=e.slice(0,f-1).join(" ");else var g=d.slice(0,f-1).join(" ")+" ",h=e.slice(0,f-1).join(" ")+" ";var i=d.pop(),j=e.pop(),k=8==c.keyCode,l=b.hash_tagging;if(k){if("#"==i)b.hash_tagging=!1,b.hash_tags=[],a.focused_book.hash_tagged_comment=h;else{var m=h.split("<b>").length!=h.split("</b>").length,n=">"==j[j.length-1];if(m&&(e=h.split("<b>"),f=e.length,h=e.slice(0,f-1).join("<b>"),g=h.replace(/<b>/,"").replace(/<\/b>/,"")),l||n)a.focused_book.hash_tagged_comment=h,a.focused_book.current_comment=g,b.is_new_word_initiation=!0,b.hash_tagging=!1,b.hash_tags=[],c.preventDefault();else{var o=a.focused_book.hash_tagged_comment;a.focused_book.hash_tagged_comment=o.substring(0,o.length-1)}}a.focused_book.current_comment&&""!=a.focused_book.current_comment||(a.focused_book.hash_tagged_comment="")}c.stopPropagation()},b.handle_hash_tags=function(d){""==a.focused_book.current_comment.trim()&&(b.is_new_word_initiation=!0);var e=a.focused_book.current_comment.split(" "),f=String.fromCharCode(d.keyCode),g=e.length,h=(e.slice(0,g-1).join(" "),e.pop()),i=b.is_new_word_initiation,j=(b.hash_tagging,13==d.keyCode);if(j&&b.hash_tags)d.preventDefault(),b.handle_selection(b.currentItem);else if(j&&!b.hash_tags){var k=a.focused_book.hash_tagged_comment.replace(/<b>/,"<a>").replace(/<\/b>/,"</a>");if(a.user.thumb)var l=a.user.thumb,m={tweet:k,thumb:l};else var m={tweet:k};a.focused_book.current_comment="",a.focused_book.hash_tagged_comment="",a.focused_book.tweets.push(m),_add_comment(m),d.preventDefault()}else{if(i&&"#"==f){var n="<b>"+f+"</b>";b.hash_tagging=!0,a.focused_book.hash_tagged_comment=a.focused_book.hash_tagged_comment+n}else if(i&&"+"==f){var n="<b>"+f+"</b>";b.hash_tagging=!0,a.focused_book.hash_tagged_comment=a.focused_book.hash_tagged_comment+n,b.search_for="TAGS"}else if(i&&"@"==f){var n="<b>"+f+"</b>";b.hash_tagging=!0,a.focused_book.hash_tagged_comment=a.focused_book.hash_tagged_comment+n,b.search_for="[AUTHORS, READERS]"}else if(" "==f)b.hash_tagging=!1,a.focused_book.hash_tagged_comment=a.focused_book.hash_tagged_comment+f,b.search_for=null;else if(b.hash_tagging){var o=a.focused_book.hash_tagged_comment.split("</b>"),p=o.length;if(p>2){var q=o[p-2]+f+"</b>"+o[p-1];a.focused_book.hash_tagged_comment=o.slice(0,p-2).join("</b>")+"</b>"+q}else{var q=o[p-2]+f+"</b>"+o[p-1];a.focused_book.hash_tagged_comment=q}}else a.focused_book.hash_tagged_comment=a.focused_book.hash_tagged_comment+f;b.search_for&&h.length>2&&(string_to_be_searched=h.slice(1,h.length)+""+f,c.search(string_to_be_searched.trim(),b.search_for,3).then(function(a){b.hash_tags=[];for(var c=a.results.data,d=0;d<c.length;d++){var e={name:c[d][0]};b.hash_tags.push(e)}})),b.is_new_word_initiation=" "==f?!0:!1}d.stopPropagation()},_add_comment=function(b){var c={id:a.focused_book.id,tweet:b};d.comment(c)},b.is_current=function(a,c){return b.current==a&&(b.currentItem=c),b.current==a},b.set_current=function(a){b.current=a},b.key_up=function(){var a=38==event.keyCode,c=40==event.keyCode;a?b.set_current(0!=b.current?b.current-1:b.hash_tags.length-1):c&&b.set_current(b.current!=b.hash_tags.length-1?b.current+1:0)},(_init=function(){b.is_new_word_initiation=!0,a.focused_book.current_comment="",a.focused_book.hash_tagged_comment="",b.current=0})()}],templateUrl:"/assets/angular/widgets/base/book/interaction_box.html"}}]),websiteApp.directive("bookTags",["$rootScope","$timeout",function(a,b){return{restrict:"E",controller:["$scope",function(c){c.show_book=function(d){zoomin_book(c,b,a,d)}}],templateUrl:"/assets/angular/widgets/base/book/book_tags.html"}}]),websiteApp.directive("recommend",["$rootScope","$timeout","widgetService",function(a,b,c){return{restrict:"E",scope:{recommend_object:"=data"},controller:["$scope",function(d){d.select_thumb=function(a){var b="true"==a.currentTarget.dataset.selected;b?(a.currentTarget.dataset.selected=!1,a.currentTarget.style.border="2px solid transparent"):(a.currentTarget.dataset.selected=!0,a.currentTarget.style.border="2px solid")},d.stop_horizontal_scroll=function(a){a.stopPropagation()},d.recommend=function(){var e=d.recommend_object.title,f=d.recommend_object.author_name;if(d.recommend_object.recommended){d.recommend_object.recommended=!1;var g="SUCCESS-"+e+" by "+f+" has been recommended to selected friends.",h=notify(a,g,b);d.$on("destroy",function(){b.cancel(h)}),c.recommend("BOOK",d.recommend_object.id,d.recommend_object.recommended)}else d.recommend_object.recommended=!0},(_init=function(){d.user={},d.user.friends=a.user.friends})()}],templateUrl:"/assets/angular/widgets/base/book/recommend.html"}}]),websiteApp.directive("markAsRead",["$rootScope","$timeout","widgetService","sharedService","stropheService",function(a,b,c,d,e){return{restrict:"E",controller:["$scope",function(b){b.mark_as_read=function(c){var f=a.user.name,g=f+"added "+b.book.title+" to Books Read.";d.mark_as_read(b,b.book,c),e.send_notification(g)}}],templateUrl:"/assets/angular/widgets/base/book/mark_as_read.html"}}]);var global_display_timer=0;