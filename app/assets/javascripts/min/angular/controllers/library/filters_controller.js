homeApp.controller("filtersController",["$scope","$rootScope","$timeout","genreService","authorService","WebsiteUIConstants","SearchUIConstants","timeGroupService","readingTimeService","infinityService","$location","sharedService","$mdBottomSheet",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.href),e="";return null!=d&&(e=d[1]),e}a._get_genres=function(){angular.isUndefined(a.info.genres)||0==a.info.genres.length?(a.info.genres=[],d.get_genres().then(function(b){angular.forEach(b,function(b){var c=null!=b.status,d=angular.extend(b,{status:c});angular.isDefined(a.selected_genre)&&b.id==a.selected_genre&&(a.info.selected_genre=b),this.push(d)},a.info.genres)})):a.info.loading=!1},a.close_filters=function(){m.hide()},a._get_authors=function(){a.info.authors=[];var b=0;e.get_popular_authors(b).then(function(b){angular.forEach(b,function(a){this.push(a)},a.info.authors),a.top_authors=a.info.authors})},a.reset_filter=function(){delete a.info.selected_genre,delete a.info.selected_author,delete a.info.selected_year,delete a.info.selected_duration,delete a.search_tag.genre,delete a.search_tag.time_group,delete a.search_tag.author,delete a.search_tag.read_time,b.filters={},o()};var o=function(){a.info.infinity=!0,a.info.books=[],p()?l.get_popular_books(a):l.filtered_books(a)},p=function(){var a=Object.keys(b.filters),c=a.indexOf("other")>=0,d=a.indexOf("skip_count")>=0,e=1==a.length&&(c||d),f=2==a.length&&c&&d,g=0==a.length||f||e;return g},q=function(){b.filters.skip_count;delete b.filters.skip_count,delete a.info.other_info,a.info.books=[],p()?l.get_popular_books(a):o()};a.select_genre=function(a){angular.isUndefined(a)||null==a?(delete b.filters.genre_id,q()):(b.filters.genre_id=a.id,o())},a.select_author=function(a){angular.isUndefined(a)||null==a?(delete b.filters.author_id,q()):(b.filters.author_id=a.id,o())},a.select_reading_time=function(a){angular.isUndefined(a)||null==a?(delete b.filters.reading_time_id,q()):(b.filters.reading_time_id=a.id,o())},a.select_publishing_year=function(a){angular.isUndefined(a)||null==a?(delete b.filters.era_id,q()):(b.filters.era_id=a.id,o())},a.search_genres=function(b){angular.isDefined(b)&&b.length>2?a.info.loading?a.info.genres=[]:(a.info.loading=!0,d.search_star_genres(b).then(function(b){a.info.loading=!1,a.info.genres=b})):(a.info.loading=!0,a._get_genres())},a.search_reading_time=function(){a.info.loading=!0,a.search_tag.read_time=""},a.search_publishing_year=function(){},a.search_authors=function(b){!a.info.loading&&angular.isDefined(b)&&b.length>2?(a.info.loading=!0,e.search_authors(b).then(function(b){a.info.loading=!1,b.length>0&&(a.info.authors=[],angular.forEach(b,function(a){var b={icon2:"icon-pen",type:g.AuthorSearch,custom_option:!0};b=angular.extend(b,a),this.push(b)},a.info.authors))})):!a.info.loading&&angular.isDefined(b)&&b.length<3&&(a.top_authors?a.info.authors=a.top_authors:a._get_authors())},a._get_time_groups=function(){h.get_time_groups().then(function(b){a.info.time_groups=[],angular.forEach(b,function(a){var b={icon2:"icon-calendar",type:g.Year,custom_option:!0};b=angular.extend(b,a),this.push(b)},a.info.time_groups)})},a._get_reading_times=function(){i.get_read_times().then(function(b){a.info.read_times=[],angular.forEach(b,function(b){var c={icon2:"icon-clock",type:g.Time,custom_option:!0};c=angular.extend(c,b),angular.isDefined(a.selected_duration)&&b.id==a.selected_duration&&(a.info.selected_duration=b),this.push(c)},a.info.read_times)})},a._detect_key=function(a){var b=a.keyCode==f.Backspace||a.keyCode==f.Delete,c=a.keyCode==f.KeyUp,d=a.keyCode==f.KeyDown,e=a.keyCode==f.KeyLeft,g=a.keyCode==f.KeyRight,h=a.keyCode==f.Enter;return{backspace_or_delete:b,keyUp:c,keyDown:d,keyLeft:e,keyRight:g,keyEnter:h}};(function(){a.search_tag={},a.info.genres=[],a.info.authors=[],a.info.time_groups=[],a.info.read_times=[];var d=c(function(){a._get_time_groups(),a._get_reading_times(),a._get_genres(),a._get_authors()},100);a.$on("destroy",function(){c.cancel(d)}),angular.isUndefined(b.filters)&&(b.filters={});var e=n("g"),f=n("d");null!=e&&(a.selected_genre=e),null!=f&&(a.selected_duration=f)})()}]);