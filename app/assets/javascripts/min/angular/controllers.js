websiteApp.controller("bookTimelineController",["$scope","$rootScope","$timeout","widgetService","$route","$routeParams","$interval",function(a,b,c,d){(_init=function(){d.get_moments().then(function(b){a.moments=b.moments})})()}]);;websiteApp.controller("recommendationsController",["$scope","$rootScope","$timeout","recommendationService","$route","$routeParams","$interval","widgetService","scroller","websiteService","sharedService","$cookieStore","RecommendationUIConstants","$location","IntroConstants","WebsiteUIConstants",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a.handle_height_of_popup=function(b,c){var d=angular.isDefined(b);if(d)var e=b.deltaY>0;else var e=c;e&&(a.ticker_popup_style={height:m.TickerPopupMaxHeight}),d&&b.stopPropagation()},a.show_all_friends=function(){a._get_friends(30)},a._set_likes=function(a,b){angular.forEach(b[0],function(a,c){this.push({id:b[1][c],name:a,icon:b[2][c]})},a)},a._set_influential_books=function(a,b){angular.forEach(b[4],function(a,c){this.push({isbn:b[3][c],id:a,title:b[5][c],author_name:b[6][c]})},a)},a._get_user_profile_info=function(c){var d=function(b){angular.isUndefined(b.detailed_info)&&j.get_detailed_info(c).then(function(c){b.detailed_info=!0,b.likes=[],b.influential_books=[],a._set_likes(b.likes,c),a._set_influential_books(b.influential_books,c)})};c==b.user.id?(d(b.user),a.fetch_new_feed()):(d(b.reader),a.fetch_new_feed(b.reader.id))},a.toggle_profile=function(c,d){var e=function(){b.user.show_profile=!1,delete b.ticker_popup},f=function(){b.user.show_profile=!0,a._get_user_profile_info(c),a._get_friends(2),delete b.ticker_popup,a._delete_focused_book()};angular.isUndefined(b.user.show_profile)||!b.user.show_profile?f():e(),angular.isDefined(d)&&(d.preventDefault(),d.stopPropagation())},a.get_news_feed=function(c){b.user.collapsed_column=!1,b.user.collapsed_left_column=!1,b.user.collapsed_filters=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!0,b.user.collapsed_friends=!0,a.expand_left_panel(),a.fetch_new_feed(c)},a.show_friends_list=function(){b.user.collapsed_friends=!1,b.user.collapsed_left_column=!1,b.user.collapsed_column=!0,b.user.collapsed_lists=!0,b.user.collapsed_filters=!0,b.user.collapsed_trends=!0,a.expand_left_panel(),a._get_friends(20)},a.fetch_new_feed=function(b){var c=!0,d=!1;a.$emit("getNotifications",d,b,c)},a.collapse_left_panel=function(){b.popups.left_panel_width={width:"15%"}},a.expand_left_panel=function(){a._delete_focused_book(),b.popups.left_panel_width={width:"34%"}},a._delete_focused_book=function(){delete b.focused_book,b.popups.left_panel_width={},b.style={}},a.toggle_settings_popup=function(c){var d=function(){b.popups={},a._delete_focused_book(),b.popups.settings_popup=!0};angular.isUndefined(b.popups.settings_popup)?d():b.popups.settings_popup?b.popups.settings_popup=!1:d(),c.stopPropagation()},a.logout=function(){k.logout()},a._expanded_notifications=function(){b.user.interact=!0,a._delete_focused_book(),delete b.ticker_popup,b.user.collapsed_column=!0,b.user.collapsed_trends=!0,b.user.collapsed_left_column=!0,b.popups.left_panel_width={width:"15%"}},a.show_interaction_box=function(b){a._expanded_notifications();var c=!1,d=!0;a.$emit("getNotifications",c,b,d)},a.show_trending_options=function(){a._expanded_notifications(),a._fetch_trending_options()},a._fetch_trending_options=function(){var c=!0;a.$emit("getNotifications",c,b.user.id)},a.handle_friends_grid_size=function(b,c){var d=angular.isDefined(b);if(d)var e=b.deltaY>0;else var e=c;e&&(a.column_heights={notifications_style:{"max-height":m.NotificationsMinHeight},friends_grid_style:{"max-height":m.FriendsGridMaxHeight,overflow:"auto"},show_filters:!1}),d&&b.stopPropagation()},a.reset=function(){a.panel_selected="",a.bookmark_selected=!1,a.read_selected=!1,_init_recommendations(),_get_recommendations()},a.stopSearching=function(a){b.searching=!1,a.currentTarget.text=""},a.hide_popups=function(){a._delete_focused_book(),delete b.ticker_popup,b.user.collapsed_column=!0,b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!0,b.user.collapsed_left_column=!0,b.popups={}},_load_icon=function(){a.drop_icon=!0,c(function(){a.drop_icon=!1},1e3)},_add_listeners=function(){r=a.$on("loadRecommendations",function(){var c=function(){b.filters.reset=!1,b.filters.reset_count=angular.isUndefined(b.filters.reset_count)?0:b.filters.reset_count+1,_get_recommendations()},d=function(){j.get_books_bookmarked(b.user.books.bookmarked.length).then(function(a){angular.forEach(a,function(a){var c=[];angular.forEach(b.labels,function(b){if(a[2].indexOf(b.name)>=0)var d={name:b.name,checked:!0};else var d={name:b.name,checked:!1};c.push(d)},c);var d={isbn:a[0],id:a[1],bookmark_status:!0,labels:c};this.push(d)},b.user.books.bookmarked)})},e=function(){j.get_books_read(b.user.books.read.length).then(function(a){angular.forEach(a,function(a){var b={isbn:a[0],id:a[1],status:!0};this.push(b)},b.user.books.read)})};a.read_selected||a.bookmark_selected?a.bookmark_selected?d():a.read_selected&&e():c()}),s=a.$on("reloadRecommendations",function(c){b.filters.reset=!0,b.filters.reset_count=0,a.reset(),c.stopPropagation()})},_init_recommendations=function(){a.recommendations={books:[],readers:[],authors:[]}},_bind_destroy=function(){a.$on("$destroy",function(){c.cancel(q),c.cancel(t)})},a._show_bookmark_tab=function(){a.bookmark_selected=!0,a.panel_selected=m.BookmarkPanel},a._initialize_filters=function(){var c=function(){b.filters.filter_id=f.filter_id,b.main_header=f.name},d=function(){b.filters.label_id=f.label_id,b.main_header=f.name,b.user.collapsed_filters=!1,b.user.collapsed_friends=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!0,b.user.collapsed_column=!0,a.expand_left_panel(),b.user.collapsed_left_column=!1},e=function(){b.filters.filter_id=f.grid_id,b.main_header=f.name,b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!1,b.user.collapsed_column=!0,a.expand_left_panel(),b.user.collapsed_left_column=!1},g=function(){b.filters.reset=!0,b.filters.reset_count=0,b.filters.trend_id=f.trend_id,b.main_header=f.name,b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_trends=!1,b.user.collapsed_lists=!0,b.user.collapsed_column=!0,a.expand_left_panel(),b.user.show_profile=!1,b.user.collapsed_left_column=!1},h=function(){delete b.main_header,delete b.filters.filter_id,delete b.filters.trend_id,delete b.filters.label_id},i=function(){a.$routeParams.type="books",b.filters.reset=!0,b.filters.filter_type=m.BookTab,b.filters.other_filters.id=a.$routeParams.book_id},j=function(){a.$routeParams.type="books",b.filters.reset=!0,b.filters.filter_type=m.BookTab,b.filters.other_filters.title=a.$routeParams.title,b.main_header=a.$routeParams.title;var c=angular.isDefined(a.$routeParams.status);c&&(b.filters.other_filters.show_all=a.$routeParams.status,b.filters.reset=!0,b.filters.reset_count=0)};if(b.filters={},b.filters.more_filters=[],b.filters.other_filters={},"books"==f.type){b.filters.filter_type=m.BookTab;var k=angular.isDefined(f.filter_id),l=angular.isDefined(f.label_id),n=angular.isDefined(f.grid_id),o=angular.isDefined(f.trend_id);k?c():l?d():o?g():n?e():h()}else"authors"==f.type?b.filters.filter_type=m.AuthorTab:"readers"==f.type?b.filters.filter_type=m.ReaderTab:f.book_id?i():f.title?j():(b.filters.filter_type=m.BookTab,a.show_notifications=!0)},_update_recommendations=function(d){if(b.filters.filter_type==m.BookTab){if(d.recommendations.books.length>1)var e="INFO- "+d.recommendations.books.length+" books found. Scroll to see more books.";else if(d.recommendations.books.length>=0)var e="INFO- "+d.recommendations.books.length+" book found.";var f=notify(b,e,c);if(a.$on("destroy",function(){c.cancel(f)}),b.loading){var g=10;if(0==d.recommendations.books.length){var e=m.ZeroBooksFound,f=notify(b,e,c);a.$on("destroy",function(){c.cancel(f)})}else{if(a._delete_focused_book(),a.recommendations.books.length>=g){a.recommendations.books=[a.recommendations.books[g-2],a.recommendations.books[g-1]];var f=c(function(){i.scrollTo(window_width/4,0,2e3)},200);a.$on("destroy",function(){c.cancel(f)})}b.filters.other_filters.title?(a.bookmark_selected=!1,a.read_selected=!1,b.hide_options=!0,_set_books(d.recommendations.books)):_set_books(d.recommendations.books)}b.loading=!1}}else b.filters.filter_type==m.AuthorTab?a.recommendations.authors=a.recommendations.authors.length>=g?d.recommendations.authors:a.recommendations.authors.concat(d.recommendations.authors):b.filters.filter_type==m.ReaderTab?a.recommendations.readers=a.recommendations.readers.length>=g?d.recommendations.readers:a.recommendations.readers.concat(d.recommendations.readers):_set_books(a.recommendations.books.length>=g?d.recommendations.books:d.recommendations.books);angular.isDefined(b.user)?b.user.faded_wrapper={opacity:"0.5"}:b.user={faded_wrapper:{opacity:"0.5"}}},_set_books=function(c){if(a.bookmark_selected){b.user.books.bookmarked=[],angular.forEach(c,function(a){var b={isbn:a[0],id:a[1],external_thumb:a[2]};this.push(b)},b.user.books.bookmarked);var d=window_width/b.user.books.bookmarked.length;a.block_style={width:d+"px"}}else{angular.forEach(c,function(a){var b={isbn:a[0],id:a[1],external_thumb:a[2]};this.push(b)},a.recommendations.books);var d=window_width/(a.recommendations.books.length+6);a.block_style={width:d+"px"}}},_get_grids=function(){d.get_grid_books().then(function(b){for(var c=[],d="",e=0;e<b.length;e++){var f=d!=b[e][0];if(f){var g=""!=d;if(g){if(c.length>4){var h={grid_text:d,grid_books:c,is_grid:!0,id:grid_id},i=a.recommendations.books.length-2;a.recommendations.books.splice(i,0,h)}c=[]}d=b[e][0],grid_id=b[e][3]}var j={isbn:b[e][1],id:b[e][2],external_thumb:b[e][4]};c.push(j)}if(c.length>4){var h={grid_text:d,grid_books:c,is_grid:!0,id:grid_id},i=a.recommendations.books.length-2;a.recommendations.books.splice(i,0,h)}})},_push_recommendations=function(){var e=3e3;q=c(function(){d.push_recommendations().then(function(d){var e={grid_text:"Books becoming movies",grid_books:d,is_grid:!0};a.recommendations.books.splice(3,0,e);var f="INFO-Check out Books becoming movies...";notify(b,f,c)})},e)},_init_analytics=function(){b.data=[]},_recordUserBehaviour=function(){var a=6e8;g(function(){b.data;_init_analytics()},a)},_get_recommendations=function(){b.loading=!0,d.get_recommendations().then(function(a){_update_recommendations(a)});angular.isUndefined(b.filters.other_filters.title)&&angular.isUndefined(b.filters.other_filters.id),a.recommendations.books.length>=4},_handle_focused_book=function(){b.focused_book=a.recommendations.books.first},a.get_notifications=function(c){if(b.user.show_profile){var d=!1;a.$emit("getNotifications",d,c)}},a._get_friends=function(a){var c=function(a,b){angular.forEach(b,function(a){thumb=null==a[2]?"/assets/profile_pic.jpeg":a[2];var b={id:a[0],name:a[1],thumb:thumb,init_book_read_count:a[3],total_count:a[4],book_read_count:a[5],bookmark_count:a[6],fav_categories:a[7].join(", ")};this.push(b)},a)};if(angular.isUndefined(b.reader)){var d=angular.isDefined(b.user.friends)?b.user.friends.length:0;(angular.isUndefined(b.user.friends)||!b.user.all_friends_shown)&&h.get_friends(b.user.id,a,d).then(function(d){a>d.length&&(b.user.all_friends_shown=!0),angular.isUndefined(b.user.friends)&&(b.user.friends=[]),c(b.user.friends,d)})}else{var d=angular.isDefined(b.reader.friends)?b.reader.friends.length:0;(angular.isUndefined(b.reader.friends)||!b.reader.all_friends_shown)&&h.get_friends(b.reader.id,a,d).then(function(d){a>d.length&&(b.reader.all_friends_shown=!0),angular.isUndefined(b.reader.friends)&&(b.reader.friends=[]),c(b.reader.friends,d)})}},a._get_labels=function(a){d.get_labels(a).then(function(a){b.labels=[],angular.isArray(a)&&a.length>0&&angular.forEach(a,function(a){null!=a[0]&&this.push({name:a[0].replace('"',""),id:a[1]})},b.labels)})},a._init_user=function(){(angular.isUndefined(b.user)||angular.isUndefined(b.user.id))&&k.is_logged_in(a)},a._init_reader=function(){k.get_user(a.$routeParams.id)},a._basic_init=function(){a.grid_view=!1,b.popups={settings_popup:!1,show_notifications_popup:!1};var d=1e4;a.drop_icon=!1,b.user=angular.extend(b.user,{collapsed_trends:!0,collapsed_friends:!0,collapsed_filters:!0,collapsed_lists:!0,collapsed_column:!0,collapsed_left_column:!0,locked:!1,interact:!1}),t=c(function(){_recordUserBehaviour()},d),a.searching=!1,_add_listeners(),_init_analytics(),_bind_destroy(),a.cover_image={"background-image":'url("'+l.get("coverImage")+'")'},a._init_user()},_init=function(){if(b.user.logged)if(a._basic_init(),a.$routeParams=f,delete b.reader,"profile"==a.$routeParams.type){b.user.show_profile=!1;var c=a.$routeParams.id;b.reader={},b.reader.id=c,a.toggle_profile(c),a._init_reader(),a._get_labels(c),a.placeholder="Write on timeline..."}else _init_recommendations(),a._get_labels(),a._initialize_filters(),a.placeholder=p.Share;else b.user={books:{bookmarked:[],read:[]},authors:{bookmarked:[],follow:[]},readers:{follow:[]},logged:!1}},a.getting_started_tour_options={steps:[{element:"#shelves",intro:o.Shelves,position:"right"},{element:"#friendsList",intro:o.Friends,position:"right"},{element:"#newsFeed",intro:o.NewsFeed,position:"right"},{element:"#listopia",intro:o.Listopia,position:"right"},{element:"#trendingList",intro:o.Trending,position:"right"},{element:"#share",intro:o.Share,position:"bottom"},{element:"#recommendationFooter",intro:o.ShelvesTab,position:"bottom"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>Next</strong>",prevLabel:"<span>Previous</span>",skipLabel:"Exit",doneLabel:"<strong>Thanks</strong>"},a.should_auto_start=function(){return!1};var q="",r="",s="",t="";_init()}]);;websiteApp.controller("searchController",["$scope","$rootScope","websiteService","$timeout","$sce","recommendationService","$routeParams","$location","SearchUIConstants","WebsiteUIConstants","$cookieStore",function(a,b,c,d,e,f,g,h,i,j,k){a._update_filters=function(b,c){var d=a._get_option_json(b,c);b==i.AuthorSearch&&(d=angular.extend(c,d)),angular.isUndefined(a.filters_added)&&(a.filters_added=[]),a.add_filters(d)},a._get_option_json=function(a){var b={type:a,custom_option:!0};switch(a){case i.Genre:var c={icon2:"icon-tag"};break;case i.AuthorSearch:var c={icon2:"icon-pen"};break;case i.Time:var c={icon2:"icon-clock"};break;case i.Year:var c={icon2:"icon-calendar"};break;case i.Country:var c={icon2:"icon-earth"}}return b=angular.extend(b,c)},a.stop_horizontal_scroll=function(a){a.stopPropagation()},a.is_active_nest=function(b){var c=!1;return a.active_nest==b.name&&(c=!0),c},a.search_custom=function(b){a.shift_search_to_top();var c=a._detect_key(b);if(c.keyEnter)a.handle_selection_option(a.search_tag.currentItem,b);else{if(c.backspace_or_delete)var d=a.search_tag.custom_input;else var d=a.search_tag.custom_input+String.fromCharCode(b.keyCode);a.search_results=[],a.custom_search==i.Genre?a._search_genres(d):a.custom_search==i.AuthorSearch&&a._search_authors(d)}},a.hide_popups=function(a){b.popups={},a.stopPropagation()},a._reset_results=function(){a.search_results=[],delete a.search_display},a._search_genres=function(b){var d="q="+b+"&count=10";a.search_display=i.SearchingGenres,a._reset_results(),c.search_genres(d).then(function(b){b.length>0?angular.forEach(b,function(b){var c=a._get_option_json(i.Genre);c=angular.extend(c,{name:b[0],id:b[1]}),this.push(c)},a.search_results):a.search_display=i.NoResultsFound})},a._search_authors=function(b){a.search_display=i.SearchingAuthor,a._reset_results(),c.search_authors("q="+b).then(function(b){b.length>0?(a.search_results=[],delete a.search_display,angular.forEach(b,function(b){var c=a._get_option_json(i.AuthorSearch);c=angular.extend(c,{name:b[0],id:b[1]}),this.push(c)},a.search_results)):a.search_display=i.NoResultsFound})},a.reset_secondary_input_focus=function(){var b=d(function(){a.website.searching_custom=!1},200);a.$on("destroy",function(){d.cancel(b)})},a._find_next_option=function(b,c){var d=!1,e=!1;return angular.forEach(a.base_book_options,function(f){filter_already_selected=!1,d&&b.indexOf(f.type)<0?(m&&a.base_book_options.length==a.filters_added.length&&a.show_books(),a.handle_selection_option(f,event),e=!0,d=!1):f.type!=c||e||(d=!0)}),e},a._handle_next_link_not_executed=function(b,c){var d=a.base_book_options.length>a.filters_added.length;if(d){var e="";angular.forEach(a.base_book_options,function(a){b.indexOf(a.type)<0&&""==e&&(e=a)}),a.handle_selection_option(e,c)}else a.show_books()},a.select_next_option=function(b){if(a.active_base==i.BookSearch){var c=[];angular.forEach(a.filters_added,function(a){c.push(a.type)},c);var d=a._find_next_option(c,b);if(m)d||a._handle_next_link_not_executed(c,event);else if(!d){var e=a.base_book_options[0];a.handle_selection_option(e,event)}}},a.handle_search_request=function(b){m?a.show_books():a.handle_options(b)},a.show_books=function(){h.path("/user/"+b.user.id+"/recommendations/books")},a._handle_year_selection=function(){a.custom_input_placeholder=i.YearPlaceholder,b.time_groups?(a.search_results=[],a._filters_added()?a.search_results=b.time_groups:a._add_years()):f.get_time_groups().then(function(c){a.search_results=[],b.time_groups=[],c=c.times,angular.forEach(c,function(b){var c=b[0].data,d=c.name,e=a._get_option_json(i.Year);e=angular.extend(e,{name:d,label:c.range}),this.push(e)},b.time_groups),a._add_years()})},a._filters_added=function(){return angular.isDefined(a.filters_added)&&a.filters_added.length>0},a._handle_list_selection=function(){if(b.book_lists)if(a.search_results=[],a._filters_added())a.search_results=b.book_lists;else{var c=d(function(){a.search_results=b.book_lists},200);a.$on("destroy",function(){d.cancel(c)})}else f.get_book_lists().then(function(c){a.search_results=[],angular.forEach(c,function(b){var c=a._get_option_json(i.List);c=angular.extend(c,{name:b[1],id:b[0]}),this.push(c)},a.search_results),b.book_lists=a.search_results})},a._handle_country_selection=function(){a.custom_input_placeholder=i.CountryPlaceholder,b.regions?(a.search_results=[],a._filters_added()?a.search_results=b.regions:a._add_countries()):f.get_countries().then(function(c){a.search_results=[],b.regions=[],angular.forEach(c.countries,function(b){var c=a._get_option_json(i.Country);c=angular.extend(b,c),this.push(c)},b.regions),a._add_countries()})},a._handle_genre_selection=function(){if(a.custom_input_placeholder=i.GenrePlaceholder,a.custom_search=i.Genre,a.search_tag.result_count=50,angular.isDefined(b.genres))a.search_results=[],a._filters_added()?a.search_results=b.genres:a._add_genres();else{var d="q=''&count=10";c.search_genres(d).then(function(c){a.search_results=[],b.genres=[],angular.forEach(c,function(b){var c=k.get(i.Genre),d=angular.isDefined(c)&&c.id!=b[1]||angular.isUndefined(c);if(d){var e=a._get_option_json(i.Genre);e=angular.extend(e,{name:b[0],id:b[1],icon:b[2]}),this.push(e)}},b.genres),a._add_genres()})}},a._handle_author_selection=function(){a.custom_input_placeholder=i.AuthorPlaceholder,a.custom_search=i.AuthorSearch;var d=0;angular.isDefined(a.filters_added)&&angular.forEach(a.filters_added,function(a){a.type==i.Genre&&(d=a.id)}),angular.isUndefined(b.authors)&&(b.authors={});var e=0==d&&angular.isDefined(b.authors.genre_filter_id)||0!=d&&(angular.isUndefined(b.authors.genre_filter_id)||b.authors.genre_filter_id!=d),f=angular.isDefined(b.authors.data)&&!e;f?(a.search_results=[],a._filters_added()?a.search_results=b.authors.data:a._add_authors()):c.search_authors("genre_id="+d).then(function(c){0!=d&&(b.authors.genre_filter_id=d),a.search_results=[],b.authors.data=[],angular.forEach(c,function(b){var c=k.get(i.AuthorSearch),d=angular.isDefined(c)&&c.id!=b[1]||angular.isUndefined(c);if(d){var e=a._get_option_json(i.AuthorSearch);e=angular.extend(e,{name:b[0],id:b[1]}),this.push(e)}},b.authors.data),a._add_authors()})},a._handle_time_selection=function(){b.read_times?(a.search_results=[],a._filters_added()?a.search_results=b.read_times:a._add_read_times()):f.get_read_times().then(function(c){a.search_results=[],b.read_times=[],angular.forEach(c.read_times,function(b){var c=b[0].data,d=c.name,e=c.type,f=a._get_option_json(i.Time);f=angular.extend(f,{name:d,tag:e}),this.push(f)},b.read_times),a._add_read_times()})},a.handle_selection_option=function(b,c){if(a.shift_search_to_top(),a._set_base_selection(),a.search_tag.result_count=10,b.level1_option){if(a.active_base==i.BookSearch){switch(a.show_compressed_base=!0,a.active_nest=b.name,a.hide_input_field=!0,a.show_secondary_input=!0,a.search_tag.custom_input="",a.website.searching_custom=!0,a.search_results=[],delete a.custom_search,delete a.search_display,a.remove_active_state(),b.type){case i.Year:a._handle_year_selection();break;case i.List:a._handle_list_selection();break;case i.Country:a._handle_country_selection();break;case i.Genre:a._handle_genre_selection();break;case i.AuthorSearch:a._handle_author_selection();break;case i.Time:a.custom_input_placeholder=i.TimePlaceholder,a._handle_time_selection();break;case i.Gender:a.search_results=[{name:i.MaleGender,icon:"icon-male"},{name:i.FemaleGender,icon:"icon-female"},{name:i.DontCareGender}];break;case i.Awards:break;case i.ComingSoon:a.coming_soon=!0}a.reset_secondary_input_focus()}}else angular.isUndefined(a.filters_added)&&(a.filters_added=[]),a.filters_added.indexOf(b)<0&&a.add_filters(b);c.stopPropagation()},a._add_authors=function(){var c=d(function(){a.search_results=b.authors.data},200);a._destroy_timeout(c)},a._add_genres=function(){var c=d(function(){a.search_results=b.genres},200);a._destroy_timeout(c)},a._add_read_times=function(){var c=d(function(){a.search_results=b.read_times},200);a._destroy_timeout(c)},a._add_countries=function(){var c=d(function(){a.search_results=b.regions},200);a._destroy_timeout(c)},a._add_years=function(){var c=d(function(){a.search_results=b.time_groups},200);a._destroy_timeout(c)},a._destroy_timeout=function(b){a.$on("destroy",function(){d.cancel(b)})},a._set_active_type=function(b){angular.forEach(a.base_book_options,function(a){a.type==b&&(a.active=!0)})},a._remove_active_type=function(b){angular.forEach(a.base_book_options,function(a){a.type==b&&delete a.active})},a.add_filters=function(c){switch(angular.forEach(a.filters_added,function(b){b.type==c.type&&(a.filters_added.splice(a.filters_added.indexOf(b),1),a.search_results.splice(0,0,b))}),m||angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),a._set_active_type(c.type),c.type){case i.Genre:var d=c.id;break;case i.AuthorSearch:var d=c.id;break;case i.Time:var d=c.tag;break;case i.Year:var d=c.name;break;case i.Country:var d=c.name;break;case i.BookSearch:b.hide_options=!0;break;case i.ReaderSearch:h.path("/reader/"+c.id+"/profile");break;case i.TextSearch:b.hide_options=!0}var e=c.type!=i.BookSearch;m?angular.isDefined(c.type)&&(k.put(c.type,c),(c.type==i.BookSearch||c.type==i.TextSearch)&&a.handle_search_request()):r?(k.put(c.type,c),a.show_books()):(e&&angular.isDefined(c.type)?(a._reset_recommendations(),b.filters.other_filters[c.type]=d,k.put(c.type,c)):a._set_filter_for_book_search(c),a.$emit("reloadRecommendations")),e&&(a.filters_added.splice(0,0,c),a.search_results.splice(a.search_results.indexOf(c),1),a.select_next_option(c.type))},a._set_filter_for_book_search=function(c){angular.isDefined(c.show_all)&&c.show_all?a._all_text_search_results(c):(a._reset_recommendations(),b.filters.other_filters.id=c.id)},a._reset_recommendations=function(){angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),delete b.filters.other_filters.show_all,delete b.filters.other_filters.title,delete b.filters.other_filters.id,b.filters.reset_count=0,b.filters.reset=!0},a._all_text_search_results=function(c){a._reset_recommendations(),b.filters.other_filters.show_all=!0,b.filters.other_filters.title=c.value},a._reset_filter=function(c){switch(c.type){case i.Time:angular.isDefined(b.read_times)&&b.read_times.splice(0,0,c);break;case i.Year:angular.isDefined(b.time_groups)&&b.time_groups.splice(0,0,c);break;case i.List:angular.isDefined(b.book_lists)&&b.book_lists.splice(0,0,c);break;case i.AuthorSearch:angular.isDefined(b.authors)&&angular.isDefined(b.authors.data)&&b.authors.data.splice(0,0,c);break;case i.Genre:angular.isDefined(b.genres)&&(angular.isDefined(b.authors)&&angular.isDefined(b.authors.genre_filter_id)&&delete b.authors.genre_filter_id,b.genres.splice(0,0,c));break;case i.Country:angular.isDefined(b.regions)&&b.regions.splice(0,0,c);break;case i.BookSearch:a._clear_book_search_filters()}k.remove(c.type),m||(delete b.filters.other_filters[c.type],delete b.filters.other_filters.show_all,delete b.filters.other_filters.title,delete b.filters.other_filters.id,a.$emit("reloadRecommendations"))},a.remove_filter=function(b,c){a._reset_filter(b),a.filters_added.splice(a.filters_added.indexOf(b),1),0==a.filters_added.length&&(a.handle_options(c),a.set_focus(200)),angular.forEach(a.base_book_options,function(d){d.type==b.type&&(a.handle_selection_option(d,c),delete d.active)}),c.stopPropagation()},a.reset_filters=function(){angular.isDefined(a.filters_added)&&(angular.forEach(a.filters_added,function(b){a._reset_filter(b)}),a.filters_added=[]),angular.isDefined(b.filters)&&angular.isDefined(b.filters.other_filters)&&a._clear_book_search_filters()},a.set_base_search=function(){switch(a.active_base){case i.BookSearch:a._init_book_search();break;case i.AuthorSearch:a._init_author_search();break;case i.ReaderSearch:a._init_reader_search()}},a.reset_base_selection=function(){a.search_tag.placeholder=i.SearchPlaceholder,a.search_results=[],delete a.active_base,k.remove("base_search")},a.handle_base_selection=function(b){if(a.hide_input_field=!1,a.show_secondary_input=!1,a.reset_filters(),a.search_tag.input="",delete a.search_display,angular.isUndefined(b))a.set_base_search();else if(angular.isDefined(a.active_base)&&a.active_base==b.type)a.reset_base_selection();else{switch(b.name){case i.BookSearchLink:a._init_book_search();break;case i.AuthorSearchLink:a._init_author_search();break;case i.ReaderSearchLink:a._init_reader_search()}a.active_base=b.type}a.website.searching=!0;d(function(){a.website.searching=!1},200);a.$on("destroy",function(){d.cancel(timeout_event)}),delete a.active_nest,delete a.search_tag.custom_input},a.is_active=function(b){var c=!1;return b.type==a.active_base&&(c=!0),c},a.is_current=function(b,c){return _set_input_field=function(){c.show_all?a.search_tag.input=c.value:c.type==i.ComingSoon||c.level1_option||c.custom_option||(a.search_tag.input=c.name)},a.search_tag.current==b&&(a.search_tag.currentItem=c),a.search_tag.current==b},a.set_current=function(b){a.search_tag.current=b},a._detect_key=function(a){var b=a.keyCode==j.Backspace||a.keyCode==j.Delete,c=a.keyCode==j.KeyUp,d=a.keyCode==j.KeyDown,e=a.keyCode==j.KeyLeft,f=a.keyCode==j.KeyRight,g=a.keyCode==j.Enter;return{backspace_or_delete:b,keyUp:c,keyDown:d,keyLeft:e,keyRight:f,keyEnter:g}},a._handle_key_up=function(){angular.isUndefined(a.search_tag.current)?a.search_tag.current=0:a.set_current(0!=a.search_tag.current?a.search_tag.current-1:a.search_results.length-1)},a._handle_key_down=function(){angular.isUndefined(a.search_tag.current)?a.search_tag.current=0:a.set_current(a.search_tag.current!=a.search_results.length-1?a.search_tag.current+1:0)},a._handle_backspace_or_delete_in_custom_search=function(c){c.length<=1?a.custom_search==i.Genre?a.search_results=b.genres:a.custom_search==i.AuthorSearch&&(a.search_results=b.authors.data):a.search_custom(event)},a._handle_backspace_or_delete_in_main_search=function(c){if(c.length<=1){a.search_tag.input="",a.search_ready=!1,a.set_base_search(),angular.isUndefined(a.active_base)&&(a.search_type=i.All);var d=angular.isDefined(b.filters.other_filters)&&(angular.isDefined(b.filters.other_filters.title)||angular.isDefined(b.filters.other_filters.id))&&!m;d&&(a._clear_book_search_filters(),a.$emit("reloadRecommendations"))}else a.get_search_results(event)},a._handle_backspace_or_delete=function(){var b=angular.isDefined(a.search_tag.custom_input);if(b)var c=a.search_tag.custom_input.trim();else var c=a.search_tag.input.trim();delete a.search_display,a.remove_active_state(),b?a._handle_backspace_or_delete_in_custom_search(c):a._handle_backspace_or_delete_in_main_search(c)},a.key_down=function(b){var c=a._detect_key(b);m||a.handle_options(b),c.keyUp?a._handle_key_up():c.keyDown?a._handle_key_down():c.backspace_or_delete?a._handle_backspace_or_delete():(c.keyLeft||c.keyRight)&&b.stopPropagation()},a._clear_book_search_filters=function(){delete b.filters.other_filters.title,delete b.filters.other_filters.show_all,delete b.filters.other_filters.id},a.close_login_box=function(){a.show_login_form=!1},a.highlight=function(a,b){var c="<span><i><b>$&</b></i></span>";return e.trustAsHtml(b.replace(new RegExp(a,"gi"),c))},a.remove_active_state=function(){delete a.search_tag.current},a._init_graph_search=function(){a.base_search_options=[{name:i.BookSearchLink,icon:"icon-book",type:i.BookSearch},{name:i.AuthorSearchLink,icon:"icon-pen",type:i.AuthorSearch},{name:i.ReaderSearchLink,icon:"icon-users",type:i.ReaderSearch}]},a._init_book_search=function(){a.base_book_options=[{name:i.BookByGenreLink,level1_option:!0,type:i.Genre,icon:"icon-tag",icon2:"icon-book"},{name:i.BookByReadingTimeLink,level1_option:!0,type:i.Time,icon:"icon-clock",icon2:"icon-book"},{name:i.BookByYearLink,level1_option:!0,type:i.Year,icon:"icon-calendar",icon2:"icon-book"},{name:i.BookByAuthorLink,level1_option:!0,type:i.AuthorSearch,icon:"icon-pen",icon2:"icon-book"}],a.search_results=a.base_book_options,m&&k.put("base_search",i.BookSearchLink)},a._init_author_search=function(){a.search_results=[{name:i.ComingSoon,level1_option:!0,type:i.ComingSoon,icon2:"icon-pen"}],a.search_tag.placeholder=i.AuthorSearchPlaceholder,m&&k.put("base_search",i.AuthorSearchLink)},a._init_reader_search=function(){a.search_results=[{name:i.ComingSoon,level1_option:!0,type:i.ComingSoon,icon2:"icon-user22"}],a.search_tag.placeholder=i.ReaderSearchPlaceholder,m&&k.put("base_search",i.ReaderSearchLink)},a._add_book_in_results=function(b){angular.forEach(b,function(a){var b={name:a[0],author_name:a[1],id:a[2],type:i.BookSearch,icon2:"icon-book"};this.push(b)},a.search_results)},a._add_author_in_results=function(b){angular.forEach(b,function(a){var b={name:a[0],id:a[2],type:i.AuthorSearch,icon2:"icon-pen"};this.push(b)},a.search_results)},a._add_reader_in_results=function(b){angular.forEach(b,function(a){var b={name:a[0],id:a[2],type:i.ReaderSearch,icon2:"icon-users"};this.push(b)},a.search_results)},a._add_mixed_type_results=function(b){angular.forEach(b,function(a){if(a[3].indexOf(i.BookLabel)>=0)var b={name:a[0],author_name:a[1],id:a[2],type:i.BookSearch,label:i.BookSearch};else if(a[3].indexOf(i.AuthorLabel)>=0)var b={name:a[0],id:a[2],type:i.AuthorSearch,label:i.AuthorSearch};else if(a[3].indexOf(i.ReaderLabel)>=0)var b={name:a[0],id:a[2],type:i.ReaderSearch,label:i.ReaderSearch};this.push(b)},a.search_results)},a._handle_search_input=function(){var b=a.search_tag.input.trim();if(a.search_ready=!0,angular.isUndefined(a.active_base)){var d=b.slice(0,1),e=d==i.Hash,f=d==i.AtTheRate,g=d==i.Plus,h=f||e||g;b.length>0&&a._set_custom_search(f,e,g)}else b.length>0&&a._set_custom_search();h&&(1==b.length&&(a.search_ready=!1),b=b.substring(1,b.length)),a.search_ready&&""!=b?b.length<3?a.search_display=i.TypeMore:(a.search_type=i.SearchAll,c.search(b,a.search_type,a.search_tag.result_count).then(function(b){if(a.search_ready){a.search_results=[];var c=b.results.data;if(a._add_mixed_type_results(c),a.search_results.length==a.search_tag.result_count){var d=a._get_search_text_item();a.search_results.push(d),delete a.search_display}else 0!=a.search_results.length?delete a.search_display:a.search_display=i.NoResultsFound;a.search_initiated=!1}})):(a.search_initiated=!1,a.set_base_search())},a._get_search_text_item=function(){return{name:"<span class='icon-list'></span><span>&nbsp;&nbsp;Show all results for '<em>"+a.search_tag.input+"</em>'</span>",show_all:!0,value:a.search_tag.input,type:i.TextSearch}},a._set_custom_search=function(b,c,d){a.search_results=[],angular.isUndefined(b)&&(a.active_base==i.AuthorSearch?b=!0:a.active_base==i.BookSearch?c=!0:a.active_base==i.ReaderSearch&&(d=!0)),a.search_type=i.SearchAll,a.search_display=i.SearchingWebsite},a.get_search_results=function(b){var c=350;a.search_results=[],a.shift_search_to_top();var e=b.keyCode==j.Enter;if(e){var f=angular.isUndefined(a.search_tag.currentItem);if(f){var g=a._get_search_text_item();m?(k.put(g.type,g),a.handle_search_request()):(a._all_text_search_results(g),a.$emit("reloadRecommendations"))}else a.handle_selection_option(a.search_tag.currentItem,b)}else if(a.search_initiated)d.cancel(l),l=d(function(){a._handle_search_input(b)},c);else{var h=String.fromCharCode(b.keyCode),n=a.search_tag.input.trim();if(n&&n.length>1){0==n.indexOf(i.Hash),0==n.indexOf(i.AtTheRate),0==n.indexOf(i.Plus)}else{h==i.Hash,h==i.AtTheRate,h==i.Plus}a.search_initiated=!0,l=d(function(){a._handle_search_input(b)},c)}},a.toggle_login_panel=function(){a.show_login_form=a.show_login_form?!1:!0},a.handle_options=function(c){m?a.shift_search_to_top():(b.hide_options&&((angular.isUndefined(a.search_tag.input)||0==a.search_tag.input.length)&&(a.hide_input_field=!1,a._init_book_search()),a.show_secondary_input=!1,b.hide_options=!1,b.user.collapsed_column=!0,b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!0,b.user.collapsed_left_column=!0,b.popups={},b.popups.left_panel_width={width:"15%"},delete b.focused_book,b.popups.left_panel_width={},b.style={},delete a.active_nest,delete a.active_base,delete a.search_tag.custom_input,a.active_base=i.BookSearch),c.stopPropagation()),a._set_base_selection()},a._set_base_selection=function(){angular.isUndefined(a.active_base)&&a.handle_base_selection(a.base_search_options[0])},a.shift_search_to_top=function(){m&&(a.trending_panel_style={"max-height":"26vh"},a.search_panel_style={top:"26%"})},a.reset_search_bar=function(c){b.hide_options=!0,a.hide_input_field=!1,delete b.user.faded_wrapper,c.stopPropagation()},a._handle_search_page=function(){a.search_initiated=!1,a.search_type=i.All,a.show_login_form=!0,a.search_tag={},a.search_tag.search_placeholder=i.SearchPlaceholder;var c=angular.isDefined(b.filters)&&angular.isDefined(b.filters.other_filters)&&angular.isDefined(b.filters.other_filters.title);a.search_tag.input=c?b.filters.other_filters.title:"",a.search_tag.result_count=10,a._init_graph_search(),m&&(a._set_cover_photo(),b.user.logged&&a.set_focus(3e3),a._set_base_search(),a._add_trends_as_notifications()),b.hide_options=g.type?!0:!1},a._set_cover_photo=function(){c.get_background_image().then(function(b){var c=j.CoverPhotoCDN+b+".jpg";a.search_style={"background-image":'url("'+c+'")'},k.put("coverImage",c)})},a._add_trends_as_notifications=function(){(angular.isUndefined(b.trending_feed)||0==b.trending_feed.length)&&c.get_trending_topics().then(function(a){b.trending_feed=[],angular.forEach(a,function(a){var b={name:a[0],id:a[1],message:a[2],url:a[3],title:a[4],thumb:a[7],large_image:a[5],keywords:a[8]};this.push(b)},b.trending_feed)})},a._add_trends_on_search_page=function(){a.trending_feed=[],c.get_trending_topics().then(function(b){angular.forEach(b,function(a){var b={name:a[0],id:a[1],thumb:a[6],keywords:a[8],large_image:a[5]};this.push(b)},a.trends)})},a.set_focus=function(b){var c=d(function(){a.website.searching=!0;d(function(){a.website.searching=!1},200)},b);a.$on("destroy",function(){d.cancel(c),d.cancel(reset_focus_param_timeout)})},a._init_genre_filter=function(){var c=k.get(i.Genre);angular.isDefined(c)&&(m||(angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),b.filters.other_filters[i.Genre]=c.id),a._set_active_type(c.type),a.filters_added.push(c))},a._init_author_filter=function(){var c=k.get(i.AuthorSearch);angular.isDefined(c)&&(m||(angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),b.filters.other_filters[i.AuthorSearch]=c.id),a._set_active_type(c.type),a.filters_added.push(c))},a._init_time_filter=function(){var c=k.get(i.Time);angular.isDefined(c)&&(m||(angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),b.filters.other_filters[i.Time]=c.tag),a._set_active_type(c.type),a.filters_added.push(c))},a._init_year_filter=function(){var c=k.get(i.Year);angular.isDefined(c)&&(m||(angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),b.filters.other_filters[i.Year]=c.name),a._set_active_type(c.type),a.filters_added.push(c))},a._init_country_filter=function(){var c=k.get(i.Country);angular.isDefined(c)&&(m||(angular.isUndefined(b.filters)&&(b.filters={other_filters:{}}),b.filters.other_filters[i.Country]=c.name),a._set_active_type(c.type),a.filters_added.push(c))},a._init_book_filter=function(){var b=k.get(i.BookSearch);angular.isDefined(b)&&(m?k.remove(i.BookSearch):(a._set_filter_for_book_search(b),a._set_active_type(b.type),a.filters_added.push(b)))},a._init_text_filter=function(){var b=k.get(i.TextSearch);angular.isDefined(b)&&(m?k.remove(i.TextSearch):(a._set_filter_for_book_search(b),a.filters_added.push(b)))},a._add_init_filters=function(){angular.isUndefined(a.filters_added)&&(a.filters_added=[]),a._init_genre_filter(),a._init_author_filter(),a._init_time_filter(),a._init_year_filter(),a._init_country_filter(),a._init_book_filter(),a._init_text_filter(),m||a.$emit("reloadRecommendations")},a._clear_filter_cookies=function(){k.remove(i.Genre),k.remove(i.AuthorSearch),k.remove(i.Time),k.remove(i.Year),k.remove(i.Country),k.remove(i.BookSearch)},a._get_ten_random_books=function(){f.get_random_books().then(function(b){a.random_books=[],angular.forEach(b,function(a){var b={id:a[0],isbn:a[1]};this.push(b)},a.random_books);for(var c=window_width/(b.length+2),d=window_width/(b.length-2),e=0,f=0;f<b.length;f++){var g=Math.random()*(d-c)+c;g>window_width-e&&(g=window_width-e),a.random_books[f]=angular.extend(a.random_books[f],{width:g,left:e}),e=e+g+5}})},a.set_book_width=function(a){return{width:a.width+"px",left:a.left+"px"}},a.increase_height=function(){m&&(a.trending_panel_style={"max-height":"50vh"},a.search_panel_style={top:"50%"})},a._set_base_search=function(){a._init_book_search(),a.search_tag.placeholder=i.SearchPlaceholder},a._init=function(){a.website.searching=!1,a.filters_added=[],a._handle_search_page(),m||a._init_book_search(),a.$on("updateFilters",function(b,c,d){a._update_filters(c,d),b.preventDefault()}),s||m?a._add_init_filters():r?a.$emit("reloadRecommendations"):a._clear_filter_cookies(),m||(b.book_lists=[],f.get_book_lists().then(function(c){angular.forEach(c,function(b){var c=a._get_option_json(i.List);c=angular.extend(c,{name:b[1],id:b[0],count:b[2]}),this.push(c)},b.book_lists)}))};var l="",m=angular.isUndefined(g.type),n=angular.isDefined(g.filter_id),o=angular.isDefined(g.label_id),p=angular.isDefined(g.grid_id),q=angular.isDefined(g.trend_id),r=n||p||q||o,s=!(m||r);a._init()}]);;websiteApp.controller("timelineController",["$scope","$rootScope","$timeout","recommendationService","$route","$routeParams","$interval",function(){}]);;websiteApp.controller("loginController",["$scope","$rootScope","websiteService","Facebook","stropheService","$timeout","$cookieStore","LoginConstants","WebsiteUIConstants","$location","$routeParams",function(a,b,c,d,e,f,g,h,i,j,k){a.submit=function(b){var c=b.keyCode==i.Enter;c&&a.authenticate(!0),b.stopPropagation()},a.recover_password=function(){delete b.user.error_message;var d=function(c){a.loading_icon=!1,b.user.error_message=c.message,b.user.password=null},e=function(c){a.$apply(function(){a.loading_icon=!1,b.user.error_message=c.message,b.user.password=null})};b.user.email?(a.loading_icon=!0,c.recover_password("email="+b.user.email).then(d,e)):b.user.error_message=h.EmailNotPresent},a.authenticate=function(d){var e=b.user.email,g=b.user.password,i=new RegExp("^.{8,}$"),j=new RegExp("^(.)\\1{7,16}$"),k=new RegExp("^.{100,}$");delete b.user.error_message;var l={email:e,password:g,old_user:d};a.loading_icon=!1;var m=function(c){b.user.error_message=c.message,b.user.profile_status=c.profile_status,b.user.logged=!0,b.user.id=c.user_id,a.loading_icon=!1;var d="INFO- Welcome back ",e=notify(b,d,f);a.$on("destroy",function(){f.cancel(e)}),a._is_logged_in(),a._redirect()},n=function(c){a.loading_icon=!1,b.user.error_message=c.data.message,b.user.password=null};b.user.email?b.user.password?i.test(b.user.password)||d?j.test(b.user.password)&&!d?b.user.error_message=h.ChooseAMoreSecurePassword:k.test(b.user.password)&&!d?b.user.error_message=h.MaximumPasswordLengthError:(a.loading_icon=!0,c.authenticate(l).then(m,n)):b.user.error_message=h.PasswordLengthError:b.user.error_message=h.PasswordNotPresent:b.user.error_message=h.EmailNotPresent},_bind_auth_listeners=function(){a.$on("event:google-plus-signin-success",function(b,d){c.handle_google_user(d),a._init_user()}),a.$on("event:google-plus-signin-failure",function(a,b){}),a.$on("Facebook:statusChange",function(b,c){c.status==h.FacebookLoginStatusCheck&&a.$apply(function(){})})},a.intent_login=function(){a.loading_icon=!0,b.user.fb_connect?(b.logged=!0,a.me()):a.login()},a.login=function(){d.login(function(b){b.status==h.FacebookLoginStatusCheck&&a.me()},{scope:"email"})},a.me=function(){d.api("/me",function(e){c.handle_facebook_user(e).then(function(){a._is_logged_in()}),b.user=e,a._init_user(),d.api("me/picture?redirect=false&type=large",function(a){c.save_user_info(a)}),a.fb_books()})},a.fb_books=function(){d.api("/me/books",function(a){a&&!a.error&&(a=angular.extend(a,{type:"books"}),c.handle_facebook_books(a))}),d.api("/me/books.reads",function(a){a&&!a.error&&(a=angular.extend(a,{type:"books.read"}),c.handle_facebook_books(a))}),d.api("/me/books.rates",function(a){a&&!a.error&&(a=angular.extend(a,{type:"books.rates"}),c.handle_facebook_books(a))}),d.api("/me/books.quotes",function(a){a&&!a.error&&(a=angular.extend(a,{type:"books.quotes"}),c.handle_facebook_books(a))}),d.api("/me/books.wants_to_read",function(a){a&&!a.error&&(a=angular.extend(a,{type:"books.wants_to_read"}),c.handle_facebook_books(a))})},a._init_user=function(){b.user.profile_status=0,b.user.logged=!0},a._is_logged_in=function(){c.get_user().then(function(a){a.logged_in&&(b.user.logged=!0,b.user.id=a.id,c.get_user_details().then(function(a){angular.extend(b.user,a)}),g.put("logged",!0))})},a._redirect=function(){angular.isDefined(k.url)&&j.path("/user/"+b.user.id+k.url)},(_init=function(){g.remove("tab"),a._is_logged_in(),_bind_auth_listeners(),b.user.fb_connect=!1,d.getLoginStatus(function(a){a.status===h.FacebookLoginStatusCheck&&(b.user.fb_connect=!0)})})()}]);;websiteApp.controller("websiteAppController",["$scope","$rootScope","$timeout","websiteService","$document","scroller","$window","WebsiteUIConstants",function(a,b,c,d,e,f,g,h){a.bindHorizontalScroll=function(b,c){b.preventDefault(),c>0?a.move_left(b):a.move_right(b),b.stopPropagation()},a._hide_popups=function(){b.user.collapsed_column=!0,b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_trends=!0,b.user.collapsed_lists=!0,b.user.collapsed_left_column=!0,b.popups={},delete b.focused_book,b.style={},delete b.ticker_popup},a.toggle_left_columns=function(){var a=function(){b.user.collapsed_filters=!0,b.user.collapsed_friends=!1,b.user.collapsed_column=!0,b.user.collapsed_lists=!0,b.user.collapsed_trends=!0,b.user.collapsed_left_column=!1},c=function(){b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_column=!1,b.user.collapsed_lists=!0,b.user.collapsed_trends=!0,b.user.collapsed_left_column=!1},d=function(){b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_column=!0,b.user.collapsed_lists=!1,b.user.collapsed_trends=!0,b.user.collapsed_left_column=!1},e=function(){b.user.collapsed_filters=!0,b.user.collapsed_friends=!0,b.user.collapsed_column=!0,b.user.collapsed_lists=!0,b.user.collapsed_trends=!1,b.user.collapsed_left_column=!1},f=function(){b.user.collapsed_filters=!1,b.user.collapsed_friends=!0,b.user.collapsed_column=!0,b.user.collapsed_lists=!0,b.user.collapsed_trends=!0,b.user.collapsed_left_column=!1};b.user.collapsed_filters?b.user.collapsed_friends?b.user.collapsed_column?b.user.collapsed_lists?b.user.collapsed_trends?c():f():e():d():c():a()},a.move_left=function(d){(b.user.collapsed_left_column||!b.user.collapsed_left_column&&!b.user.locked)&&a._hide_popups();var e=1e3,h=(document.body.scrollWidth,g.pageXOffset),i=.4*window_height;if(angular.isDefined(d))if("click"==d.type){a.delta_x=angular.isDefined(a.delta_x)?a.delta_x+i:i;var j=c(function(){f.scrollTo(h-a.delta_x,0,e),delete a.delta_x,c.cancel(j)},400)}else f.scrollTo(h-i,0,e);else f.scrollTo(h-i,0,e)},a.move_right=function(d){(b.user.collapsed_left_column||!b.user.collapsed_left_column&&!b.user.locked)&&a._hide_popups();var e=1e3,h=document.body.scrollWidth,i=g.pageXOffset,j=.4*window_height,k=i+2.5*window_width>h;if(k&&(b.loading||(b.loading=!0,b.$broadcast("loadRecommendations"))),angular.isDefined(d))if("click"==d.type){a.delta_x=angular.isDefined(a.delta_x)?a.delta_x+j:j;var l=c(function(){f.scrollTo(i+a.delta_x,0,e),delete a.delta_x,c.cancel(l)},400)}else f.scrollTo(i+j,0,e);else f.scrollTo(i+j,0,e)},a.scroll_one_page_right=function(a){var c=document.body.scrollWidth;if(a)var d=a.pageX-window_width/2,e=a.pageX+window_width>c;else var d=g.pageXOffset,e=g.pageXOffset;e&&b.$broadcast("loadRecommendations");var h=window_width;f.scrollTo(d+h,0,2e3)},a.scroll_one_page_left=function(a){if(a)var b=a.pageX-window_width/2;else var b=g.pageXOffset-window_width/2;var c=window_width;f.scrollTo(b-c,0,2e3)},a.showFeebackForm=function(){},a.show_uploader=function(){a.uploader=!0},a.close_notification=function(){b.notification_active=!1},_bind_feedback_form=function(){g.onmouseleave=function(){}},_load_recommendations=function(){var a=document.body.scrollWidth,c=event.pageX+window_width>a;c&&b.$broadcast("loadRecommendations")},_get_book_details=function(c){filter="id="+c,d.get_book_details(filter).then(function(c){a.detailed_book.book=c,b.show_book=!0})},_bind_emit=function(){show_book_event=a.$on("expandBook",function(a,c,d,e,f){b.book_x=d,b.screen_x=e,b.total_x=f,_get_book_details(c),a.stopPropagation()})},a._show_trending_feed=function(){a.show_feed={trending:!0},a.show_trending=!0},a._show_reader_feed=function(b,c){if(a.show_feed={readers:!0},angular.isDefined(c)&&c&&(delete a.readers_notifications,a.readers_notifications=[]),angular.isDefined(a.readers_notifications))var e=a.readers_notifications.length;else var e=0;d.get_notifications(e,b).then(function(b){angular.isUndefined(a.readers_notifications)&&(a.readers_notifications=[]),a.readers_notifications=b.notifications.concat(a.readers_notifications)})},a._show_personal_feed=function(b,c){if(a.show_feed={personal:!0},angular.isDefined(c)&&c&&(a.personal_notifications=[]),angular.isDefined(a.personal_notifications))var e=a.personal_notifications.length;else var e=0;d.get_notifications(e,b).then(function(b){angular.isUndefined(a.personal_notifications)&&(a.personal_notifications=[]),a.personal_notifications=b.notifications.concat(a.personal_notifications)})},a._show_news_feed=function(c){a.show_feed={news:!0};var e=function(b){angular.isUndefined(a.news_feed)&&(a.news_feed=[]),a.news_feed=b.notifications.concat(a.news_feed)};if(angular.isDefined(c)&&c&&(a.news_feed=[]),angular.isDefined(a.news_feed))var f=a.news_feed.length;else var f=0;if(angular.isDefined(b.reader)){var g=b.reader.id,h=!0;d.get_notifications(f,g,h).then(function(a){e(a)})}else d.get_notifications(f).then(function(a){e(a)})},_add_listeners=function(){j=a.$on("moveRight",function(){i=c(function(){a.move_right()},1e3)}),add_to_notifications=a.$on("addToNotifications",function(b,c){if(c instanceof Array){var d=!1;angular.forEach(a.notifications,function(a){a.id==c[0].id&&(d=!0)}),d||(a.notifications=a.notifications.concat(c))}else a.notifications.push(c),angular.isDefined(a.personal_notifications)&&a.personal_notifications.push(c);b.stopPropagation()}),get_notifications_event=a.$on("getNotifications",function(c,d,e,f){angular.isUndefined(d)||!d?angular.isDefined(e)?angular.isDefined(b.reader)&&e==b.reader.id?a._show_reader_feed(e,f):a._show_personal_feed(e,f):a._show_news_feed(f):a._show_trending_feed()}),k=a.$on("getLatestNotification",function(){d.get_latest_notification().then(function(b){a.notifications.push(b.notification)})})},a.toggle_login_panel=function(){a.show_login_form=a.show_login_form?!1:!0},_initiate_loading_page=function(){a.loading=!0,a.drop_icon=!1,a.show_login_form=!1,c(function(){a.loading=!1},2e3),c(function(){a.drop_icon=!0},1e3)},a.toggle_notifications=function(){a.show_notifications?(a.show_notifications=!1,a.notifications_seen=!0):a.show_notifications=!0},a.handle_keyboard_bindings=function(b){b.keyCode==h.KeyRight?(b.preventDefault(),a.move_right(b)):b.keyCode==h.KeyLeft&&(b.preventDefault(),a.move_left(b)),b.stopPropagation()},a.search=function(){var c=event.currentTarget==event.srcElement&&!b.show_book;c&&($("body").css("white-space","normal"),a.website.searching=!0,b.keyCode=event.keyCode)},_handle_socket_error=function(){},_init=function(){_initiate_loading_page(),a.more_filters=[],a.show_notifications=!0,a.notifications_seen=!1,angular.isDefined(b.focused_book)&&(b.focused_book.level2_option=""),a.website={},a.website.searching=!1,a.website.show_search_page=!0,_bind_emit(),_bind_feedback_form(),_add_listeners(),_handle_socket_error(),b.notification_active=!1,b.user={books:{bookmarked:[],read:[]},authors:{bookmarked:[],follow:[]},readers:{follow:[]},logged:!1},a._detect_browser()},a._detect_browser=function(){{var a,b,c,d=(navigator.appVersion,navigator.userAgent),e=navigator.appName,f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10);h.BrowserIncompatible}-1!=(b=d.indexOf("Opera"))?(e="Opera",f=d.substring(b+6),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("MSIE"))?(e="Microsoft Internet Explorer",f=d.substring(b+5)):-1!=(b=d.indexOf("Chrome"))?(e="Chrome",f=d.substring(b+7)):-1!=(b=d.indexOf("Safari"))?(e="Safari",f=d.substring(b+7),-1!=(b=d.indexOf("Version"))&&(f=d.substring(b+8))):-1!=(b=d.indexOf("Firefox"))?(e="Firefox",f=d.substring(b+8)):(a=d.lastIndexOf(" ")+1)<(b=d.lastIndexOf("/"))&&(e=d.substring(a,b),f=d.substring(b+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),-1!=(c=f.indexOf(";"))&&(f=f.substring(0,c)),-1!=(c=f.indexOf(" "))&&(f=f.substring(0,c)),g=parseInt(""+f,10),isNaN(g)&&(f=""+parseFloat(navigator.appVersion),g=parseInt(navigator.appVersion,10))};var i="",j="",k="";_init()}]);