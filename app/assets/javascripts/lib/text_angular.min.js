(function(e,t,n){"use strict";function i(){this.$get=["$$sanitizeUri",function(e){return function(t){var n=[];C(t,D(n,function(t,n){return!/^unsafe/.test(e(t,n))}));return n.join("")}}]}function s(e){var n=[];var r=D(n,t.noop);r.chars(e);return n.join("")}function N(e){var t={},n=e.split(","),r;for(r=0;r<n.length;r++)t[n[r]]=true;return t}function C(e,n){function x(e,r,i,s){r=t.lowercase(r);if(b[r]){while(m.last()&&w[m.last()]){T("",m.last())}}if(y[r]&&m.last()==r){T("",r)}s=v[r]||!!s;if(!s)m.push(r);var o={};i.replace(a,function(e,t,n,r,i){var s=n||r||i||"";o[t]=A(s)});if(n.start)n.start(r,o,s)}function T(e,r){var i=0,s;r=t.lowercase(r);if(r)for(i=m.length-1;i>=0;i--)if(m[i]==r)break;if(i>=0){for(s=m.length-1;s>=i;s--)if(n.end)n.end(m[s]);m.length=i}}var i,s,d,m=[],g=e;m.last=function(){return m[m.length-1]};while(e){s=true;if(!m.last()||!E[m.last()]){if(e.indexOf("<!--")===0){i=e.indexOf("--",4);if(i>=0&&e.lastIndexOf("-->",i)===i){if(n.comment)n.comment(e.substring(4,i));e=e.substring(i+3);s=false}}else if(h.test(e)){d=e.match(h);if(d){e=e.replace(d[0],"");s=false}}else if(l.test(e)){d=e.match(u);if(d){e=e.substring(d[0].length);d[0].replace(u,T);s=false}}else if(f.test(e)){d=e.match(o);if(d){e=e.substring(d[0].length);d[0].replace(o,x);s=false}}if(s){i=e.indexOf("<");var S=i<0?e:e.substring(0,i);e=i<0?"":e.substring(i);if(n.chars)n.chars(A(S))}}else{e=e.replace(new RegExp("(.*)<\\s*\\/\\s*"+m.last()+"[^>]*>","i"),function(e,t){t=t.replace(c,"$1").replace(p,"$1");if(n.chars)n.chars(A(t));return""});T("",m.last())}if(e==g){throw r("badparse","The sanitizer was unable to parse the following block "+"of html: {0}",e)}g=e}T()}function A(e){if(!e){return""}var t=L.exec(e);var n=t[1];var r=t[3];var i=t[2];if(i){k.innerHTML=i.replace(/</g,"&lt;");i="textContent"in k?k.textContent:k.innerText}return n+i+r}function O(e){return e.replace(/&/g,"&").replace(d,function(e){var t=e.charCodeAt(0);if(t<=159||t==173||t>=1536&&t<=1540||t==1807||t==6068||t==6069||t>=8204&&t<=8207||t>=8232&&t<=8239||t>=8288&&t<=8303||t==65279||t>=65520&&t<=65535)return"&#"+t+";";return e}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}function _(e){var n="";var r=e.split(";");t.forEach(r,function(e){var r=e.split(":");if(r.length==2){var i=M(t.lowercase(r[0]));var e=M(t.lowercase(r[1]));if(i==="color"&&(e.match(/^rgb\([0-9%,\. ]*\)$/i)||e.match(/^rgba\([0-9%,\. ]*\)$/i)||e.match(/^hsl\([0-9%,\. ]*\)$/i)||e.match(/^hsla\([0-9%,\. ]*\)$/i)||e.match(/^#[0-9a-f]{3,6}$/i)||e.match(/^[a-z]*$/i))||i==="text-align"&&(e==="left"||e==="right"||e==="center"||e==="justify")||i==="float"&&(e==="left"||e==="right"||e==="none")||(i==="width"||i==="height")&&e.match(/[0-9\.]*(px|em|rem|%)/))n+=i+": "+e+";"}});return n}function D(e,n){var r=false;var i=t.bind(e,e.push);return{start:function(e,s,o){e=t.lowercase(e);if(!r&&E[e]){r=e}if(!r&&S[e]===true){i("<");i(e);t.forEach(s,function(r,s){var o=t.lowercase(s);var u=e==="img"&&o==="src"||o==="background";if(o==="style"&&(r=_(r))!==""||T[o]===true&&(x[o]!==true||n(r,u))){i(" ");i(s);i('="');i(O(r));i('"')}});i(o?"/>":">")}},end:function(e){e=t.lowercase(e);if(!r&&S[e]===true){i("</");i(e);i(">")}if(e==r){r=false}},chars:function(e){if(!r){i(O(e))}}}}var r=t.$$minErr("$sanitize");var o=/^<\s*([\w:-]+)((?:\s+[\w:-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)\s*>/,u=/^<\s*\/\s*([\w:-]+)[^>]*>/,a=/([\w:-]+)(?:\s*=\s*(?:(?:"((?:[^"])*)")|(?:'((?:[^'])*)')|([^>\s]+)))?/g,f=/^</,l=/^<\s*\//,c=/<!--(.*?)-->/g,h=/<!DOCTYPE([^>]*?)>/i,p=/<!\[CDATA\[(.*?)]]>/g,d=/([^\#-~| |!])/g;var v=N("area,br,col,hr,img,wbr");var m=N("colgroup,dd,dt,li,p,tbody,td,tfoot,th,thead,tr"),g=N("rp,rt"),y=t.extend({},g,m);var b=t.extend({},m,N("address,article,"+"aside,blockquote,caption,center,del,dir,div,dl,figure,figcaption,footer,h1,h2,h3,h4,h5,"+"h6,header,hgroup,hr,ins,map,menu,nav,ol,pre,script,section,table,ul"));var w=t.extend({},g,N("a,abbr,acronym,b,"+"bdi,bdo,big,br,cite,code,del,dfn,em,font,i,img,ins,kbd,label,map,mark,q,ruby,rp,rt,s,"+"samp,small,span,strike,strong,sub,sup,time,tt,u,var"));var E=N("script,style");var S=t.extend({},v,b,w,y);var x=N("background,cite,href,longdesc,src,usemap");var T=t.extend({},x,N("abbr,align,alt,axis,bgcolor,border,cellpadding,cellspacing,class,clear,"+"color,cols,colspan,compact,coords,dir,face,headers,height,hreflang,hspace,"+"ismap,lang,language,nohref,nowrap,rel,rev,rows,rowspan,rules,"+"scope,scrolling,shape,size,span,start,summary,target,title,type,"+"valign,value,vspace,width"));var k=document.createElement("pre");var L=/^(\s*)([\s\S]*?)(\s*)$/;var M=function(){if(!String.prototype.trim){return function(e){return t.isString(e)?e.replace(/^\s\s*/,"").replace(/\s\s*$/,""):e}}return function(e){return t.isString(e)?e.trim():e}}();t.module("ngSanitize",[]).provider("$sanitize",i);t.module("ngSanitize").filter("linky",["$sanitize",function(e){var n=/((ftp|https?):\/\/|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>]/,r=/^mailto:/;return function(i,o){function h(e){if(!e){return}f.push(s(e))}function p(e,n){f.push("<a ");if(t.isDefined(o)){f.push('target="');f.push(o);f.push('" ')}f.push('href="');f.push(e);f.push('">');h(n);f.push("</a>")}if(!i)return i;var u;var a=i;var f=[];var l;var c;while(u=a.match(n)){l=u[0];if(u[2]==u[3])l="mailto:"+l;c=u.index;h(a.substr(0,c));p(l,u[0].replace(r,""));a=a.substring(c+u[0].length)}h(a);return e(f.join(""))}}])})(window,window.angular)


/*
textAngular
Author : Austin Anderson
License : 2013 MIT
Version 1.2.0

See README.md or https://github.com/fraywing/textAngular/wiki for requirements and use.
*/
var textAngularSetup = {
	translationStrings: {
		toggleHTML: "Toggle HTML",
		insertImage: "Please enter a image URL to insert",
		insertLink: "Please enter a URL to insert",
		insertVideo: "Please enter a youtube URL to embed"
	},
	selectableElements: ['a','img','div'],
	options: {
		toolbar: [
			['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'pre', 'quote'],
			['bold', 'italics', 'underline', 'ul', 'ol', 'redo', 'undo', 'clear'],
			['justifyLeft','justifyCenter','justifyRight'],
			['html', 'insertImage', 'insertLink', 'insertVideo']
		],
		classes: {
			focussed: "focussed",
			toolbar: "btn-toolbar",
			toolbarGroup: "btn-group",
			toolbarButton: "btn btn-default",
			toolbarButtonActive: "active",
			disabled: "disabled",
			textEditor: 'form-control',
			htmlEditor: 'form-control'
		},
		setup: {
			// wysiwyg mode
			textEditorSetup: function($element){ /* Do some processing here */ },
			// raw html
			htmlEditorSetup: function($element){ /* Do some processing here */ }
		},
		defaultFileDropHandler:
			/* istanbul ignore next: untestable image processing */
			function(file, insertAction){
				var reader = new FileReader();
				if(file.type.substring(0, 5) === 'image'){
					reader.onload = function() {
						if(reader.result !== '') insertAction('insertImage', reader.result, true);
					};
	
					reader.readAsDataURL(file);
					return true;
				}
				return false;
			}
	},
	// configure initial textAngular tools here via taRegisterTool
	registerToolsFunction: function(taRegisterTool, $window, taTranslations){
		taRegisterTool("html", {
			buttontext: taTranslations.toggleHTML,
			action: function(){
				this.$editor().switchView();
			},
			activeState: function(){
				return this.$editor().showHtml;
			}
		});
		// add the Header tools
		// convenience functions so that the loop works correctly
		var _retActiveStateFunction = function(q){
			return function(){ return this.$editor().queryFormatBlockState(q); };
		};
		var headerAction = function(){
			return this.$editor().wrapSelection("formatBlock", "<" + this.name.toUpperCase() +">");
		};
		angular.forEach(['h1','h2','h3','h4','h5','h6'], function(h){
			taRegisterTool(h.toLowerCase(), {
				buttontext: h.toUpperCase(),
				action: headerAction,
				activeState: _retActiveStateFunction(h.toLowerCase())
			});
		});
		taRegisterTool('p', {
			buttontext: 'P',
			action: function(){
				return this.$editor().wrapSelection("formatBlock", "<P>");
			},
			activeState: function(){ return this.$editor().queryFormatBlockState('p'); }
		});
		taRegisterTool('pre', {
			buttontext: 'pre',
			action: function(){
				return this.$editor().wrapSelection("formatBlock", "<PRE>");
			},
			activeState: function(){ return this.$editor().queryFormatBlockState('pre'); }
		});
		taRegisterTool('ul', {
			iconclass: 'fa fa-list-ul',
			action: function(){
				return this.$editor().wrapSelection("insertUnorderedList", null);
			},
			activeState: function(){ return document.queryCommandState('insertUnorderedList'); }
		});
		taRegisterTool('ol', {
			iconclass: 'fa fa-list-ol',
			action: function(){
				return this.$editor().wrapSelection("insertOrderedList", null);
			},
			activeState: function(){ return document.queryCommandState('insertOrderedList'); }
		});
		taRegisterTool('quote', {
			iconclass: 'fa fa-quote-right',
			action: function(){
				return this.$editor().wrapSelection("formatBlock", "<BLOCKQUOTE>");
			},
			activeState: function(){ return this.$editor().queryFormatBlockState('blockquote'); }
		});
		taRegisterTool('undo', {
			iconclass: 'fa fa-undo',
			action: function(){
				return this.$editor().wrapSelection("undo", null);
			}
		});
		taRegisterTool('redo', {
			iconclass: 'fa fa-repeat',
			action: function(){
				return this.$editor().wrapSelection("redo", null);
			}
		});
		taRegisterTool('bold', {
			iconclass: 'fa fa-bold',
			action: function(){
				return this.$editor().wrapSelection("bold", null);
			},
			activeState: function(){
				return document.queryCommandState('bold');
			},
			commandKeyCode: 98
		});
		taRegisterTool('justifyLeft', {
			iconclass: 'fa fa-align-left',
			action: function(){
				return this.$editor().wrapSelection("justifyLeft", null);
			},
			activeState: function(commonElement){
				var result = false;
				if(commonElement) result = commonElement.css('text-align') === 'left' || commonElement.attr('align') === 'left' ||
					(commonElement.css('text-align') !== 'right' && commonElement.css('text-align') !== 'center' && !document.queryCommandState('justifyRight') && !document.queryCommandState('justifyCenter'));
				result = result || document.queryCommandState('justifyLeft');
				return result;
			}
		});
		taRegisterTool('justifyRight', {
			iconclass: 'fa fa-align-right',
			action: function(){
				return this.$editor().wrapSelection("justifyRight", null);
			},
			activeState: function(commonElement){
				var result = false;
				if(commonElement) result = commonElement.css('text-align') === 'right';
				result = result || document.queryCommandState('justifyRight');
				return result;
			}
		});
		taRegisterTool('justifyCenter', {
			iconclass: 'fa fa-align-center',
			action: function(){
				return this.$editor().wrapSelection("justifyCenter", null);
			},
			activeState: function(commonElement){
				var result = false;
				if(commonElement) result = commonElement.css('text-align') === 'center';
				result = result || document.queryCommandState('justifyCenter');
				return result;
			}
		});
		taRegisterTool('italics', {
			iconclass: 'fa fa-italic',
			action: function(){
				return this.$editor().wrapSelection("italic", null);
			},
			activeState: function(){
				return document.queryCommandState('italic');
			},
			commandKeyCode: 105
		});
		taRegisterTool('underline', {
			iconclass: 'fa fa-underline',
			action: function(){
				return this.$editor().wrapSelection("underline", null);
			},
			activeState: function(){
				return document.queryCommandState('underline');
			},
			commandKeyCode: 117
		});
		taRegisterTool('clear', {
			iconclass: 'fa fa-ban',
			action: function(deferred, restoreSelection){
				this.$editor().wrapSelection("removeFormat", null);
				var _ranges = [];
				// if rangy, do better removal. Else just change everything to a <p> tag - this don't work so well on lists
				if(this.$window.rangy && this.$window.rangy.getSelection &&
					(_ranges = this.$window.rangy.getSelection().getAllRanges()).length === 1
				){
					var possibleNodes = angular.element(_ranges[0].commonAncestorContainer);
					// remove lists
					var removeListElements = function(list){
						list = angular.element(list);
						var prevElement = list;
						angular.forEach(list.children(), function(liElem){
							var newElem = angular.element('<p></p>');
							newElem.html(angular.element(liElem).html());
							prevElement.after(newElem);
							prevElement = newElem;
						});
						list.remove();
					};
					angular.forEach(possibleNodes.find("ul"), removeListElements);
					angular.forEach(possibleNodes.find("ol"), removeListElements);
					// clear out all class attributes. These do not seem to be cleared via removeFormat
					var $editor = this.$editor();
					var recursiveRemoveClass = function(node){
						node = angular.element(node);
						if(node[0] !== $editor.displayElements.text[0]) node.removeAttr('class');
						angular.forEach(node.children(), recursiveRemoveClass);
					};
					angular.forEach(possibleNodes, recursiveRemoveClass);
					// check if in list. If not in list then use formatBlock option
					if(possibleNodes[0].tagName.toLowerCase() !== 'li' &&
						possibleNodes[0].tagName.toLowerCase() !== 'ol' &&
						possibleNodes[0].tagName.toLowerCase() !== 'ul') this.$editor().wrapSelection("formatBlock", "<p>");
				}else this.$editor().wrapSelection("formatBlock", "<p>");
				restoreSelection();
			}
		});
		
		taRegisterTool('insertImage', {
			iconclass: 'fa fa-picture-o',
			action: function(){
				var imageLink;
				imageLink = $window.prompt(taTranslations.insertImage, 'http://');
				if(imageLink && imageLink !== '' && imageLink !== 'http://'){
					return this.$editor().wrapSelection('insertImage', imageLink, true);
				}
			},
			onElementSelect: {
				element: 'img',
				action: function(event, $element, editorScope){
					// setup the editor toolbar
					// Credit to the work at http://hackerwins.github.io/summernote/ for this editbar logic/display
					var finishEdit = function(){
						editorScope.updateTaBindtaTextElement();
						editorScope.hidePopover();
					};
					event.preventDefault();
					editorScope.displayElements.popover.css('width', '375px');
					var container = editorScope.displayElements.popoverContainer;
					container.empty();
					var buttonGroup = angular.element('<div class="btn-group" style="padding-right: 6px;">');
					var fullButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">100% </button>');
					fullButton.on('click', function(event){
						event.preventDefault();
						$element.css({
							'width': '100%',
							'height': ''
						});
						finishEdit();
					});
					var halfButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">50% </button>');
					halfButton.on('click', function(event){
						event.preventDefault();
						$element.css({
							'width': '50%',
							'height': ''
						});
						finishEdit();
					});
					var quartButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">25% </button>');
					quartButton.on('click', function(event){
						event.preventDefault();
						$element.css({
							'width': '25%',
							'height': ''
						});
						finishEdit();
					});
					var resetButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1">Reset</button>');
					resetButton.on('click', function(event){
						event.preventDefault();
						$element.css({
							width: '',
							height: ''
						});
						finishEdit();
					});
					buttonGroup.append(fullButton);
					buttonGroup.append(halfButton);
					buttonGroup.append(quartButton);
					buttonGroup.append(resetButton);
					container.append(buttonGroup);
					
					buttonGroup = angular.element('<div class="btn-group" style="padding-right: 6px;">');
					var floatLeft = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-left"></i></button>');
					floatLeft.on('click', function(event){
						event.preventDefault();
						$element.css('float', 'left');
						finishEdit();
					});
					var floatRight = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-right"></i></button>');
					floatRight.on('click', function(event){
						event.preventDefault();
						$element.css('float', 'right');
						finishEdit();
					});
					var floatNone = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-align-justify"></i></button>');
					floatNone.on('click', function(event){
						event.preventDefault();
						$element.css('float', '');
						finishEdit();
					});
					buttonGroup.append(floatLeft);
					buttonGroup.append(floatNone);
					buttonGroup.append(floatRight);
					container.append(buttonGroup);
					
					buttonGroup = angular.element('<div class="btn-group">');
					var remove = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" unselectable="on" tabindex="-1"><i class="fa fa-trash-o"></i></button>');
					remove.on('click', function(event){
						event.preventDefault();
						$element.remove();
						finishEdit();
					});
					buttonGroup.append(remove);
					container.append(buttonGroup);
					
					editorScope.showPopover($element);
				}
			}
		});
		taRegisterTool('insertVideo', {
			iconclass: 'fa fa-youtube-play',
			action: function(){
				var urlPrompt;
				urlPrompt = $window.prompt(taTranslations.insertVideo, 'http://');
				if (urlPrompt && urlPrompt !== '' && urlPrompt !== 'http://') {
					// get the video ID
					var ids = urlPrompt.match(/(\?|&)v=[^&]*/);
					/* istanbul ignore else: if it's invalid don't worry - though probably should show some kind of error message */
					if(ids.length > 0){
						// create the embed link
						var urlLink = "http://www.youtube.com/embed/" + ids[0].substring(3);
						// create the HTML
						var embed = '<div class="ta-insert-video" style="padding:20px"><iframe src="' + urlLink + '" allowfullscreen="true" width="300" frameborder="0" height="250"></iframe></div>';
						// insert
						return this.$editor().wrapSelection('insertHTML', embed, true);
					}
				}
			}
		});	
		taRegisterTool('insertLink', {
			iconclass: 'fa fa-link',
			action: function(){
				var urlLink;
				urlLink = $window.prompt(taTranslations.insertLink, 'http://');
				if(urlLink && urlLink !== '' && urlLink !== 'http://'){
					return this.$editor().wrapSelection('createLink', urlLink, true);
				}
			},
			activeState: function(commonElement){
				if(commonElement) return commonElement[0].tagName === 'A';
				return false;
			},
			onElementSelect: {
				element: 'a',
				action: function(event, $element, editorScope){
					// setup the editor toolbar
					// Credit to the work at http://hackerwins.github.io/summernote/ for this editbar logic
					event.preventDefault();
					editorScope.displayElements.popover.css('width', '305px');
					var container = editorScope.displayElements.popoverContainer;
					container.empty();
					container.css('line-height', '28px');
					var link = angular.element('<a href="' + $element.attr('href') + '" target="_blank">' + $element.attr('href') + '</a>');
					link.css({
						'display': 'inline-block',
						'max-width': '200px',
						'overflow': 'hidden',
						'text-overflow': 'ellipsis',
						'white-space': 'nowrap',
						'vertical-align': 'middle'
					});
					container.append(link);
					var buttonGroup = angular.element('<div class="btn-group pull-right">');
					var reLinkButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" tabindex="-1" unselectable="on"><i class="fa fa-edit icon-edit"></i></button>');
					reLinkButton.on('click', function(event){
						event.preventDefault();
						var urlLink = $window.prompt(taTranslations.insertLink, $element.attr('href'));
						if(urlLink !== ''){
							$element.attr('href', urlLink);
							editorScope.updateTaBindtaTextElement();
						}
						editorScope.hidePopover();
					});
					buttonGroup.append(reLinkButton);
					var unLinkButton = angular.element('<button type="button" class="btn btn-default btn-sm btn-small" tabindex="-1" unselectable="on"><i class="fa fa-unlink icon-unlink"></i></button>');
					// directly before ths click event is fired a digest is fired off whereby the reference to $element is orphaned off
					unLinkButton.on('click', function(event){
						event.preventDefault();
						$element.replaceWith($element.contents());
						editorScope.updateTaBindtaTextElement();
						editorScope.hidePopover();
					});
					buttonGroup.append(unLinkButton);
					container.append(buttonGroup);
					editorScope.showPopover($element);
				}
			}
		});
	}
};


(function(){"Use Strict";function n(e,n){var r=Math.max(t.rules.length-1,0);if(t.insertRule){t.insertRule(e+"{"+n+"}",r)}else{t.addRule(e,n,r)}return r}function r(e){if(t.removeRule){t.removeRule(e)}else{t.deleteRule(e)}}function u(e,t){if(!e||e===""||o.hasOwnProperty(e))throw"textAngular Error: A unique name is required for a Tool Definition";if(t.display&&(t.display===""||angular.element(t.display).length===0)||!t.display&&!t.buttontext&&!t.iconclass)throw'textAngular Error: Tool Definition for "'+e+'" does not have a valid display/iconclass/buttontext value';o[e]=t}var e=function(){var e,t=-1;var n=window.navigator.userAgent;var r=n.indexOf("MSIE ");var i=n.indexOf("Trident/");if(r>0){t=parseInt(n.substring(r+5,n.indexOf(".",r)),10)}else if(i>0){var s=n.indexOf("rv:");t=parseInt(n.substring(s+3,n.indexOf(".",s)),10)}return t>-1?t:e}();var t=function(){var e=document.createElement("style");e.appendChild(document.createTextNode(""));document.head.appendChild(e);return e.sheet}();var i=false;var s=angular.module("textAngular",["ngSanitize"]);if(textAngularSetup===undefined){throw"textAngular Error: Setup Options are not defined, see textAngularSetup.js for example."}s.value("taOptions",textAngularSetup.options);s.value("taSelectableElements",textAngularSetup.selectableElements);var o={};s.constant("taTranslations",textAngularSetup.translationStrings);s.constant("taRegisterTool",u);s.value("taTools",o);s.run(["taRegisterTool","$window","taTranslations",function(e,t,n){angular.forEach(o,function(e,t){delete o[t]});textAngularSetup.registerToolsFunction(e,t,n)}]);s.directive("textAngular",["$compile","$timeout","taOptions","taSanitize","textAngularManager","$window","$animate","$log",function(e,t,n,r,i,s,o,u){return{require:"?ngModel",scope:{},restrict:"EA",link:function(r,a,f,l){var c,h,p,d,v,m,g,y,b=Math.floor(Math.random()*1e16),w=f.name?f.name:"textAngularEditor"+b;angular.extend(r,angular.copy(n),{wrapSelection:function(e,t,n){try{document.execCommand(e,false,t)}catch(i){}if(n){r["reApplyOnSelectorHandlerstaTextElement"+b]()}r.displayElements.text[0].focus()},showHtml:false});if(f.taFocussedClass)r.classes.focussed=f.taFocussedClass;if(f.taTextEditorClass)r.classes.textEditor=f.taTextEditorClass;if(f.taHtmlEditorClass)r.classes.htmlEditor=f.taHtmlEditorClass;if(f.taTextEditorSetup)r.setup.textEditorSetup=r.$parent.$eval(f.taTextEditorSetup);if(f.taHtmlEditorSetup)r.setup.htmlEditorSetup=r.$parent.$eval(f.taHtmlEditorSetup);if(f.taFileDrop)r.fileDropHandler=r.$parent.$eval(f.taFileDrop);else r.fileDropHandler=r.defaultFileDropHandler;g=a[0].innerHTML;a[0].innerHTML="";r.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea></textarea>"),text:angular.element("<div></div>"),popover:angular.element('<div class="popover fade bottom" style="max-width: none; width: 305px;"><div class="arrow"></div></div>'),popoverContainer:angular.element('<div class="popover-content"></div>')};r.displayElements.popover.append(r.displayElements.popoverContainer);a.append(r.displayElements.popover);r.displayElements.popover.on("mousedown",function(e){e.preventDefault();return false});r.showPopover=function(e){r.displayElements.popover.css("top",e[0].offsetTop+e[0].offsetHeight+"px");r.displayElements.popover.css("left",e[0].offsetLeft+e[0].offsetWidth/2-152.5+"px");r.displayElements.popover.css("display","block");o.addClass(r.displayElements.popover,"in");t(function(){r.displayElements.html.parent().one("click",r.hidePopover)},100)};r.hidePopover=function(){o.removeClass(r.displayElements.popover,"in",function(){r.displayElements.popover.css("display","");r.displayElements.popoverContainer.attr("style","");r.displayElements.popoverContainer.attr("class","popover-content")})};r.setup.htmlEditorSetup(r.displayElements.html);r.setup.textEditorSetup(r.displayElements.text);r.displayElements.html.attr({id:"taHtmlElement"+b,"ng-show":"showHtml","ta-bind":"ta-bind","ng-model":"html"});r.displayElements.text.attr({id:"taTextElement"+b,contentEditable:"true","ng-hide":"showHtml","ta-bind":"ta-bind","ng-model":"html"});a.append(r.displayElements.text);a.append(r.displayElements.html);r.displayElements.forminput.attr("name",w);a.append(r.displayElements.forminput);if(f.tabindex){a.removeAttr("tabindex");r.displayElements.text.attr("tabindex",f.tabindex);r.displayElements.html.attr("tabindex",f.tabindex)}if(f.placeholder){r.displayElements.text.attr("placeholder",f.placeholder);r.displayElements.html.attr("placeholder",f.placeholder)}if(f.taDisabled){r.displayElements.text.attr("ta-readonly","disabled");r.displayElements.html.attr("ta-readonly","disabled");r.disabled=r.$parent.$eval(f.taDisabled);r.$parent.$watch(f.taDisabled,function(e){r.disabled=e;if(r.disabled){a.addClass(r.classes.disabled)}else{a.removeClass(r.classes.disabled)}})}e(r.displayElements.text)(r);e(r.displayElements.html)(r);r.updateTaBindtaTextElement=r["updateTaBindtaTextElement"+b];r.updateTaBindtaHtmlElement=r["updateTaBindtaHtmlElement"+b];a.addClass("ta-root");r.displayElements.text.addClass("ta-text ta-editor "+r.classes.textEditor);r.displayElements.html.addClass("ta-html ta-editor "+r.classes.textEditor);r._actionRunning=false;var E=false;r.startAction=function(){r._actionRunning=true;if(s.rangy&&s.rangy.saveSelection){E=s.rangy.saveSelection();return function(){if(E)s.rangy.restoreSelection(E)}}};r.endAction=function(){r._actionRunning=false;if(E)s.rangy.removeMarkers(E);E=false;r.updateSelectedStyles();if(!r.showHtml)r["updateTaBindtaTextElement"+b]()};v=function(){a.addClass(r.classes.focussed);y.focus()};r.displayElements.html.on("focus",v);r.displayElements.text.on("focus",v);m=function(e){if(!r._actionRunning&&document.activeElement!==r.displayElements.html[0]&&document.activeElement!==r.displayElements.text[0]){a.removeClass(r.classes.focussed);y.unfocus();t(function(){a.triggerHandler("blur")},0)}e.preventDefault();return false};r.displayElements.html.on("blur",m);r.displayElements.text.on("blur",m);r.queryFormatBlockState=function(e){return e.toLowerCase()===document.queryCommandValue("formatBlock").toLowerCase()};r.switchView=function(){r.showHtml=!r.showHtml;if(r.showHtml){t(function(){return r.displayElements.html[0].focus()},100)}else{t(function(){return r.displayElements.text[0].focus()},100)}};if(f.ngModel){var S=true;l.$render=function(){if(S){S=false;var e=r.$parent.$eval(f.ngModel);if((e===undefined||e===null)&&g&&g!==""){l.$setViewValue(g)}}r.displayElements.forminput.val(l.$viewValue);if(!r._elementSelectTriggered&&document.activeElement!==r.displayElements.html[0]&&document.activeElement!==r.displayElements.text[0]){r.html=l.$viewValue||""}}}else{r.displayElements.forminput.val(g);r.html=g}r.$watch("html",function(e,t){if(e!==t){if(f.ngModel&&l.$viewValue!==e)l.$setViewValue(e);r.displayElements.forminput.val(e)}});if(f.taTargetToolbars)y=i.registerEditor(w,r,f.taTargetToolbars.split(","));else{var x=angular.element('<div text-angular-toolbar name="textAngularToolbar'+b+'">');if(f.taToolbar)x.attr("ta-toolbar",f.taToolbar);if(f.taToolbarClass)x.attr("ta-toolbar-class",f.taToolbarClass);if(f.taToolbarGroupClass)x.attr("ta-toolbar-group-class",f.taToolbarGroupClass);if(f.taToolbarButtonClass)x.attr("ta-toolbar-button-class",f.taToolbarButtonClass);if(f.taToolbarActiveButtonClass)x.attr("ta-toolbar-active-button-class",f.taToolbarActiveButtonClass);if(f.taFocussedClass)x.attr("ta-focussed-class",f.taFocussedClass);a.prepend(x);e(x)(r.$parent);y=i.registerEditor(w,r,["textAngularToolbar"+b])}r.$on("$destroy",function(){i.unregisterEditor(w)});r.$on("ta-element-select",function(e,t){y.triggerElementSelect(e,t)});r.$on("ta-drop-event",function(e,t,n){r.displayElements.text[0].focus();if(n.originalEvent.dataTransfer&&n.originalEvent.dataTransfer.files&&n.originalEvent.dataTransfer.files.length>0){angular.forEach(n.originalEvent.dataTransfer.files,function(e){try{return r.fileDropHandler(e,r.wrapSelection)||r.fileDropHandler!==r.defaultFileDropHandler&&r.defaultFileDropHandler(e,r.wrapSelection)}catch(t){u.error(t)}});n.preventDefault();n.stopPropagation()}});r._bUpdateSelectedStyles=false;r.updateSelectedStyles=function(){var e;if(s.rangy&&s.rangy.getSelection&&(e=s.rangy.getSelection().getAllRanges()).length===1&&e[0].commonAncestorContainer.parentNode!==r.displayElements.text[0]){y.updateSelectedStyles(angular.element(e[0].commonAncestorContainer.parentNode))}else y.updateSelectedStyles();if(r._bUpdateSelectedStyles)t(r.updateSelectedStyles,200)};c=function(){if(!r._bUpdateSelectedStyles){r._bUpdateSelectedStyles=true;r.$apply(function(){r.updateSelectedStyles()})}};r.displayElements.html.on("keydown",c);r.displayElements.text.on("keydown",c);h=function(){r._bUpdateSelectedStyles=false};r.displayElements.html.on("keyup",h);r.displayElements.text.on("keyup",h);p=function(e){r.$apply(function(){if(y.sendKeyCommand(e)){if(!r._bUpdateSelectedStyles){r.updateSelectedStyles()}e.preventDefault();return false}})};r.displayElements.html.on("keypress",p);r.displayElements.text.on("keypress",p);d=function(){r._bUpdateSelectedStyles=false;r.$apply(function(){r.updateSelectedStyles()})};r.displayElements.html.on("mouseup",d);r.displayElements.text.on("mouseup",d)}}}]).directive("taBind",["taSanitize","$timeout","taFixChrome","taSelectableElements",function(t,s,o,u){return{require:"ngModel",scope:{},link:function(a,f,l,c){var h=f.attr("contenteditable")!==undefined&&f.attr("contenteditable");var p=h||f[0].tagName.toLowerCase()==="textarea"||f[0].tagName.toLowerCase()==="input";var d=false;var v=false;var m=e===undefined?"<p><br></p>":"<p></p>";var g=function(){if(h)return f[0].innerHTML;if(p)return f.val();throw"textAngular Error: attempting to update non-editable taBind"};a.$parent["updateTaBind"+(l.id||"")]=function(){if(!d)c.$setViewValue(g())};if(p){f.on("paste cut",function(){if(!d)s(function(){c.$setViewValue(g())},0)});if(!h){f.on("change blur",function(){if(!d)c.$setViewValue(g())})}else{f.on("keyup",function(){if(!d){c.$setViewValue(g())}});f.on("blur",function(){v=false;var e=g();if(!d){if(e===m)c.$setViewValue("");else c.$setViewValue(g())}c.$render()});if(l.placeholder){var y;if(l.id)y=n("#"+l.id+".placeholder-text:before",'content: "'+l.placeholder+'"');else throw"textAngular Error: An unique ID is required for placeholders to work";a.$on("$destroy",function(){r(y)})}f.on("focus",function(){v=true;c.$render()})}}var b=function(e){return c.$oldViewValue=t(o(e),c.$oldViewValue)};c.$parsers.push(b);c.$formatters.push(b);var w=function(e){a.$emit("ta-element-select",this);e.preventDefault();return false};var E=function(e){if(!i){i=true;a.$emit("ta-drop-event",this,e);s(function(){i=false},100)}};a.$parent["reApplyOnSelectorHandlers"+(l.id||"")]=function(){if(!d)angular.forEach(u,function(e){f.find(e).off("click",w).on("click",w)})};c.$render=function(){var e=c.$viewValue||"";if(document.activeElement!==f[0]){if(h){if(l.placeholder){if(e===""){if(v)f.removeClass("placeholder-text");else f.addClass("placeholder-text");f[0].innerHTML=m}else{f.removeClass("placeholder-text");f[0].innerHTML=e}}else{if(e==="")f[0].innerHTML=m;else f[0].innerHTML=e}if(!d){angular.forEach(u,function(e){f.find(e).on("click",w)});f.on("drop",E)}else{f.off("drop",E)}}else if(f[0].tagName.toLowerCase()!=="textarea"&&f[0].tagName.toLowerCase()!=="input"){f[0].innerHTML=e}else{f.val(e)}}else{if(h){f.removeClass("placeholder-text")}}};if(l.taReadonly){d=a.$parent.$eval(l.taReadonly);if(d){if(f[0].tagName.toLowerCase()==="textarea"||f[0].tagName.toLowerCase()==="input"){f.attr("disabled","disabled")}if(f.attr("contenteditable")!==undefined&&f.attr("contenteditable")){f.removeAttr("contenteditable")}}else{if(f[0].tagName.toLowerCase()==="textarea"||f[0].tagName.toLowerCase()==="input"){f.removeAttr("disabled")}else if(h){f.attr("contenteditable","true")}}a.$parent.$watch(l.taReadonly,function(e,t){if(t===e)return;if(e){if(f[0].tagName.toLowerCase()==="textarea"||f[0].tagName.toLowerCase()==="input"){f.attr("disabled","disabled")}if(f.attr("contenteditable")!==undefined&&f.attr("contenteditable")){f.removeAttr("contenteditable")}angular.forEach(u,function(e){f.find(e).on("click",w)});f.off("drop",E)}else{if(f[0].tagName.toLowerCase()==="textarea"||f[0].tagName.toLowerCase()==="input"){f.removeAttr("disabled")}else if(h){f.attr("contenteditable","true")}angular.forEach(u,function(e){f.find(e).off("click",w)});f.on("drop",E)}d=e})}if(h&&!d){angular.forEach(u,function(e){f.find(e).on("click",w)});f.on("drop",E)}}}}]).directive("taMaxText",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){function s(e){var t=angular.element("<div/>");t.html(e);var n=t.text().length;if(n<=i){r.$setValidity("taMaxText",true);return e}else{r.$setValidity("taMaxText",false);return undefined}}var i=parseInt(e.$eval(n.taMaxText));if(isNaN(i)){throw"Max text must be an integer"}n.$observe("taMaxText",function(e){i=parseInt(e);if(isNaN(i)){throw"Max text must be an integer"}if(r.$dirty){r.$setViewValue(r.$viewValue)}});r.$parsers.unshift(s)}}}).factory("taFixChrome",function(){var e=function(e){var t=angular.element("<div>"+e+"</div>");var n=angular.element(t).find("span");for(var r=0;r<n.length;r++){var i=angular.element(n[r]);if(i.attr("style")&&i.attr("style").match(/line-height: 1.428571429;|color: inherit; line-height: 1.1;/i)){i.attr("style",i.attr("style").replace(/( |)font-family: inherit;|( |)line-height: 1.428571429;|( |)line-height:1.1;|( |)color: inherit;/ig,""));if(!i.attr("style")||i.attr("style")===""){if(i.next().length>0&&i.next()[0].tagName==="BR")i.next().remove();i.replaceWith(i[0].innerHTML)}}}var s=t[0].innerHTML.replace(/style="[^"]*?(line-height: 1.428571429;|color: inherit; line-height: 1.1;)[^"]*"/ig,"");if(s!==t[0].innerHTML)t[0].innerHTML=s;return t[0].innerHTML};return e}).factory("taSanitize",["$sanitize",function(t){function n(e,t){var r=[];var i=e.children();if(i.length){angular.forEach(i,function(e){r=r.concat(n(angular.element(e),t))})}if(e.attr(t))r.push(e);return r}return function(r,i){var s=angular.element("<div>"+r+"</div>");angular.forEach(n(s,"align"),function(e){e.css("text-align",e.attr("align"));e.removeAttr("align")});r=s[0].innerHTML;var o;try{o=t(r)}catch(u){o=i||""}return o}}]).directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction","$window",function(e,t,n,r,i,s){return{scope:{name:"@"},restrict:"EA",link:function(o,u,a){if(!o.name||o.name==="")throw"textAngular Error: A toolbar requires a name";angular.extend(o,angular.copy(n));if(a.taToolbar)o.toolbar=o.$parent.$eval(a.taToolbar);if(a.taToolbarClass)o.classes.toolbar=a.taToolbarClass;if(a.taToolbarGroupClass)o.classes.toolbarGroup=a.taToolbarGroupClass;if(a.taToolbarButtonClass)o.classes.toolbarButton=a.taToolbarButtonClass;if(a.taToolbarActiveButtonClass)o.classes.toolbarButtonActive=a.taToolbarActiveButtonClass;if(a.taFocussedClass)o.classes.focussed=a.taFocussedClass;o.disabled=true;o.focussed=false;u[0].innerHTML="";u.addClass("ta-toolbar "+o.classes.toolbar);o.$watch("focussed",function(){if(o.focussed)u.addClass(o.classes.focussed);else u.removeClass(o.classes.focussed)});var f=function(t,n){var r;if(t&&t.display){r=angular.element(t.display)}else r=angular.element("<button type='button'>");r.addClass(o.classes.toolbarButton);r.attr("name",n.name);r.attr("unselectable","on");r.attr("ng-disabled","isDisabled()");r.attr("tabindex","-1");r.attr("ng-click","executeAction()");r.attr("ng-class","displayActiveToolClass(active)");r.on("mousedown",function(e){e.preventDefault();return false});if(t&&!t.display&&!n._display){r[0].innerHTML="";if(t.buttontext)r[0].innerHTML=t.buttontext;if(t.iconclass){var i=angular.element("<i>"),s=r[0].innerHTML;i.addClass(t.iconclass);r[0].innerHTML="";r.append(i);if(s&&s!=="")r.append("&nbsp;"+s)}}n._lastToolDefinition=angular.copy(t);return e(r)(n)};o.tools={};o._parent={disabled:true,showHtml:false,queryFormatBlockState:function(){return false}};var l={$window:s,$editor:function(){return o._parent},isDisabled:function(){return this.$eval("disabled")||this.$eval("disabled()")||this.name!=="html"&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled},displayActiveToolClass:function(e){return e?o.classes.toolbarButtonActive:""},executeAction:i};angular.forEach(o.toolbar,function(e){var t=angular.element("<div>");t.addClass(o.classes.toolbarGroup);angular.forEach(e,function(e){o.tools[e]=angular.extend(o.$new(true),r[e],l,{name:e});o.tools[e].$element=f(r[e],o.tools[e]);t.append(o.tools[e].$element)});u.append(t)});o.updateToolDisplay=function(e,t,n){var r=o.tools[e];if(r){if(r._lastToolDefinition&&!n)t=angular.extend({},r._lastToolDefinition,t);if(t.buttontext===null&&t.iconclass===null&&t.display===null)throw'textAngular Error: Tool Definition for updating "'+e+'" does not have a valid display/iconclass/buttontext value';if(t.buttontext===null){delete t.buttontext}if(t.iconclass===null){delete t.iconclass}if(t.display===null){delete t.display}toolElement=f(t,r);r.$element.replaceWith(toolElement);r.$element=toolElement}};t.registerToolbar(o);o.$on("$destroy",function(){t.unregisterToolbar(o.name)})}}}]).service("taToolExecuteAction",["$q",function(e){return function(t){if(t!==undefined)this.$editor=function(){return t};var n=e.defer(),r=n.promise,i=this.$editor();r["finally"](function(){i.endAction.call(i)});var s;try{s=this.action(n,i.startAction())}catch(o){}if(s||s===undefined){n.resolve()}}}]).service("textAngularManager",["taToolExecuteAction",function(e){var t={},n={};return{registerEditor:function(r,i,s){if(!r||r==="")throw"textAngular Error: An editor requires a name";if(!i)throw"textAngular Error: An editor requires a scope";if(n[r])throw'textAngular Error: An Editor with name "'+r+'" already exists';var u=[];angular.forEach(s,function(e){if(t[e])u.push(t[e])});n[r]={scope:i,toolbars:s,_registerToolbar:function(e){if(this.toolbars.indexOf(e.name)>=0)u.push(e)},editorFunctions:{disable:function(){angular.forEach(u,function(e){e.disabled=true})},enable:function(){angular.forEach(u,function(e){e.disabled=false})},focus:function(){angular.forEach(u,function(e){e._parent=i;e.disabled=false;e.focussed=true})},unfocus:function(){angular.forEach(u,function(e){e.disabled=true;e.focussed=false})},updateSelectedStyles:function(e){angular.forEach(u,function(t){angular.forEach(t.tools,function(t){if(t.activeState){t.active=t.activeState(e)}})})},sendKeyCommand:function(t){var n=false;if(t.ctrlKey||t.metaKey)angular.forEach(o,function(r,s){if(r.commandKeyCode&&r.commandKeyCode===t.which){for(var o=0;o<u.length;o++){if(u[o].tools[s]!==undefined){e.call(u[o].tools[s],i);n=true;break}}}});return n},triggerElementSelect:function(e,t){var n=false;t=angular.element(t);angular.forEach(o,function(r,s){if(r.onElementSelect&&r.onElementSelect.element&&r.onElementSelect.element.toLowerCase()===t[0].tagName.toLowerCase()&&(!r.onElementSelect.filter||r.onElementSelect.filter(t))){for(var o=0;o<u.length;o++){if(u[o].tools[s]!==undefined){r.onElementSelect.action.call(u[o].tools[s],e,t,i);n=true;break}}}});return n}}};return n[r].editorFunctions},retrieveEditor:function(e){return n[e]},unregisterEditor:function(e){delete n[e]},registerToolbar:function(e){if(!e)throw"textAngular Error: A toolbar requires a scope";if(!e.name||e.name==="")throw"textAngular Error: A toolbar requires a name";if(t[e.name])throw'textAngular Error: A toolbar with name "'+e.name+'" already exists';t[e.name]=e;angular.forEach(n,function(t){t._registerToolbar(e)})},retrieveToolbar:function(e){return t[e]},retrieveToolbarsViaEditor:function(e){var t=[],n=this;angular.forEach(this.retrieveEditor(e).toolbars,function(e){t.push(n.retrieveToolbar(e))});return t},unregisterToolbar:function(e){delete t[e]},updateToolsDisplay:function(e){var t=this;angular.forEach(e,function(e,n){t.updateToolDisplay(n,e)})},resetToolsDisplay:function(){var e=this;angular.forEach(o,function(t,n){e.resetToolDisplay(n)})},updateToolDisplay:function(e,n){var r=this;angular.forEach(t,function(t,i){r.updateToolbarToolDisplay(i,e,n)})},resetToolDisplay:function(e){var n=this;angular.forEach(t,function(t,r){n.resetToolbarToolDisplay(r,e)})},updateToolbarToolDisplay:function(e,n,r){if(t[e])t[e].updateToolDisplay(n,r);else throw'textAngular Error: No Toolbar with name "'+e+'" exists'},resetToolbarToolDisplay:function(e,n){if(t[e])t[e].updateToolDisplay(n,o[n],true);else throw'textAngular Error: No Toolbar with name "'+e+'" exists'},refreshEditor:function(e){if(n[e]){n[e].scope.updateTaBindtaTextElement();if(!n[e].scope.$$phase)n[e].scope.$digest()}else throw'textAngular Error: No Editor with name "'+e+'" exists'}}}])})()